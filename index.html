<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portfolio de Inversiones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Font Awesome (para íconos) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Data Labels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Bootstrap CSS para Toasts (opcional, si decides usarlos) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap JS para Toasts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* Variables CSS */
    :root {
      --primary: #2c3e50;
      --secondary: #34495e;
      --accent: #1e3799; /* Azul oscuro para bordes */
      --success: #27ae60;
      --danger: #c0392b;
      --background: #ecf0f1;
      --text: #2c3e50;
      --readonly-bg: #f5f5f5;
      --button-export: #8e44ad;
      --button-chart: #16a085;
      --summary-bg: #1e3799; /* Azul oscuro */
      --btn-edit-color: #f1c40f;
      --btn-edit-hover: #f39c12;
      --button-size: 1.1rem 1.5rem;
      --small-button-size: 0.8rem 1rem;
      --transition-speed: 0.3s;
      --modal-overlay-bg: rgba(0,0,0,0.5);
      --form-overlay-bg: rgba(0,0,0,0.7);
    }

    /* Modo Oscuro */
    body.dark-mode {
      --primary: #34495e;
      --secondary: #2c3e50;
      --accent: #1e3799; /* Azul oscuro para bordes */
      --success: #27ae60;
      --danger: #c0392b;
      --background: #2c3e50;
      --text: #ecf0f1;
      --readonly-bg: #3d566e;
      --button-export: #8e44ad;
      --button-chart: #16a085;
      --summary-bg: #1e3799; /* Azul oscuro */
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background);
      color: var(--text);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    header, footer {
      background-color: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
      position: relative;
    }

    main {
      padding: 1rem;
      transition: margin-left var(--transition-speed);
    }

    /* Menú Lateral */
    .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 2000; /* Asegura que esté por encima de otros elementos */
      top: 0;
      left: 0;
      background-color: var(--secondary);
      overflow-x: hidden;
      transition: width var(--transition-speed);
      padding-top: 60px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }

    .sidenav a {
      padding: 10px 20px;
      text-decoration: none;
      font-size: 1.1rem;
      color: white;
      display: block;
      transition: background-color var(--transition-speed);
    }

    .sidenav a:hover {
      background-color: var(--primary);
    }

    .sidenav .closebtn {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    /* Botón de Configuración */
    .open-sidenav-btn {
      font-size: 1.5rem;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
      position: fixed;
      top: 10px;
      left: 20px;
      z-index: 2100; /* Por encima del menú lateral */
    }

    /* Botón Modo Oscuro */
    .toggle-dark-mode {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--secondary);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color var(--transition-speed);
      z-index: 1000;
    }

    .toggle-dark-mode:hover {
      background-color: var(--primary);
    }

    /* Secciones */
    .filters, .actions, .summary, .tables, .modals {
      margin-bottom: 1.5rem;
    }

    /* Ajustes de la Sección de Filtros */
    .filters {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      overflow-x: auto;
      background-color: var(--secondary);
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .filters label {
      flex: 0 0 150px; /* Ancho fijo para las etiquetas */
      font-weight: bold;
      color: white;
    }

    .filters select, 
    .filters input[type="month"] {
      flex: 1 1 auto;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border-color var(--transition-speed);
      background-color: white;
      color: var(--text);
      min-width: 150px;
    }

    /* Cambios para Modo Oscuro en Filtros */
    body.dark-mode .filters label {
      color: #ecf0f1;
    }

    body.dark-mode .filters select, 
    body.dark-mode .filters input[type="month"] {
      background-color: #3d566e;
      color: #ecf0f1;
      border: 1px solid #555;
    }

    .filters select:focus, .filters input[type="month"]:focus {
      border-color: var(--accent);
      outline: none;
    }

    @media (max-width: 800px) {
      .filters {
        flex-wrap: wrap;
        justify-content: center;
      }

      .filters label {
        flex: 0 0 100%;
        text-align: center;
        color: white;
      }

      .filters select, 
      .filters input[type="month"] {
        flex: 0 0 100%;
        max-width: 100%;
        background-color: #ecf0f1;
      }

      body.dark-mode .filters select, 
      body.dark-mode .filters input[type="month"] {
        background-color: #3d566e;
        color: #ecf0f1;
      }
    }

    /* Centrando botones */
    .actions > div {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .actions-top button, .actions-middle button, .actions-bottom button, .actions-extra button {
      padding: var(--button-size);
      margin: 0.3rem;
      border: none;
      border-radius: 5px;
      background-color: var(--secondary);
      color: white;
      cursor: pointer;
      transition: background-color var(--transition-speed), transform var(--transition-speed);
      font-size: 1rem;
      min-width: 150px; /* Ajuste de ancho mínimo */
    }

    .actions-top button:hover, .actions-middle button:hover, .actions-bottom button:hover, .actions-extra button:hover {
      background-color: var(--primary);
      transform: scale(1.05);
    }

    .actions-bottom .export-button, .actions-bottom .chart-button {
      background-color: var(--button-export);
      min-width: 200px; /* Más ancho para botones especiales */
    }

    .actions-bottom .chart-button {
      background-color: var(--button-chart);
    }

    .actions-bottom .export-button:hover {
      background-color: #7d3c98;
    }

    .actions-bottom .chart-button:hover {
      background-color: #148f77;
    }

    /* Resumen */
    .summary {
      display: flex;
      justify-content: space-between;
      background-color: var(--summary-bg);
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .summary-box {
      width: 48%;
      background-color: white;
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: 2px solid var(--accent); /* Azul oscuro */
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode .summary-box {
      background-color: #34495e;
      color: #ecf0f1;
    }

    .summary-box h4 {
      text-align: center;
      margin-bottom: 1rem;
      color: var(--primary);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.5rem;
    }

    body.dark-mode .summary-box h4 {
      color: white;
    }

    .summary-item {
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .summary-label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    .summary-value {
      font-size: 1.2rem;
    }

    /* Tablas */
    .tables table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode .tables table {
      background-color: #34495e;
      color: #ecf0f1;
    }

    .tables th, .tables td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: left;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    .tables th {
      background-color: var(--secondary);
      color: white;
    }

    body.dark-mode .tables th {
      background-color: var(--primary);
      color: #ecf0f1;
    }

    .tables tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    body.dark-mode .tables tr:nth-child(even) {
      background-color: #3d566e;
    }

    .number-cell {
      text-align: right;
      min-width: 100px; /* Ajuste de ancho mínimo */
    }

    .acciones {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
    }

    .acciones .btn-group {
      display: flex;
      gap: 0.3rem;
    }

    .acciones button {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color var(--transition-speed);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .acciones button:hover {
      opacity: 0.8;
    }

    .btn-edit {
      background-color: var(--btn-edit-color);
      color: black;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-edit:hover {
      background-color: var(--btn-edit-hover);
    }

    .btn-sell {
      background-color: var(--success);
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-delete {
      background-color: var(--danger);
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      margin-top: 0.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--modal-overlay-bg);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000; /* Por encima del menú lateral */
      animation: fadeIn 0.3s ease-out;
    }

    .modal.visible {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode .modal-content {
      background-color: #34495e;
      color: #ecf0f1;
    }

    .modal-content h3, .modal-content h4 {
      margin-top: 0;
    }

    .close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--danger);
    }

    /* Forms */
    .form-section {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: background-color var(--transition-speed), color var(--transition-speed);
      z-index: 4000; /* Por encima de los modales */
      max-height: 90%;
      overflow-y: auto;
      width: 90%;
      display: none; /* Inicialmente oculto */
    }

    body.dark-mode .form-section {
      background-color: #34495e;
      color: #ecf0f1;
    }

    .form-section.visible {
      display: block;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      gap: 1rem;
    }

    .form-group {
      flex: 1;
      min-width: 200px; /* Aumentado para ocupar más espacio */
      margin-right: 1rem;
      margin-bottom: 0.5rem;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .form-group input, .form-group select {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
      background-color: var(--background);
      color: var(--text);
      min-width: 15ch;
    }

    body.dark-mode .form-group input, 
    body.dark-mode .form-group select {
      background-color: #3d566e;
      color: #ecf0f1;
      border: 1px solid #555;
    }

    .form-group input:focus, .form-group select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 5px rgba(30,55,153,0.5);
      outline: none;
    }

    .form-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
    }

    .form-actions button {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: var(--primary);
      color: white;
      transition: background-color var(--transition-speed), transform var(--transition-speed);
      font-size: 1rem;
      min-width: 150px;
    }

    .form-actions button:hover {
      background-color: var(--secondary);
      transform: scale(1.05);
    }

    .cancel-button {
      background-color: var(--danger);
    }

    .cancel-button:hover {
      background-color: #a93226;
    }

    /* Estilos para el modal mejorado */
    #currentValuesForm {
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      background-color: white;
      padding: 2rem;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode #currentValuesForm {
      background-color: #34495e;
      color: #ecf0f1;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    #currentValuesForm h3 {
      margin-bottom: 1.5rem;
      color: var(--primary);
      text-align: center;
    }

    /* Interruptor Mejorado */
    .toggle-switch {
      position: relative;
      width: 50px;
      display: inline-block;
    }

    .toggle-switch input {
      display: none;
    }

    .toggle-switch label {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      border-radius: 25px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .toggle-switch label::after {
      content: "";
      position: absolute;
      width: 22px;
      height: 22px;
      left: 4px;
      top: 4px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s, background-color 0.3s;
    }

    .toggle-switch input:checked + label {
      background-color: var(--success);
    }

    .toggle-switch input:checked + label::after {
      transform: translateX(26px);
    }

    /* Cambios para Visibilidad del Interruptor en Modo Oscuro */
    body.dark-mode .toggle-switch label {
      background-color: #555;
    }

    body.dark-mode .toggle-switch input:checked + label::after {
      background-color: #ecf0f1;
    }

    /* Estilos para botones */
    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color var(--transition-speed), transform var(--transition-speed);
    }

    .btn-primary {
      background-color: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background-color: darken(var(--accent), 10%);
    }

    .btn-secondary {
      background-color: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background-color: darken(var(--secondary), 10%);
    }

    .btn-success {
      background-color: var(--success);
      color: white;
    }

    .btn-success:hover {
      background-color: darken(var(--success), 10%);
    }

    .btn-danger {
      background-color: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background-color: #a93226;
    }

    /* Estilos para la búsqueda */
    #searchInversiones {
      width: 100%;
      padding: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
    }

    #searchInversiones:focus {
      border-color: var(--accent);
      box-shadow: 0 0 5px rgba(30,55,153,0.5);
      outline: none;
    }

    /* Animaciones para botones */
    .btn {
      transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Toasts */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 5000;
    }

    /* Mejoras en la Tabla de Operaciones Cerradas */
    #closedOperationsBody tr.selected {
      background-color: rgba(30, 55, 153, 0.3);
    }

    body.dark-mode #closedOperationsBody tr.selected {
      background-color: rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body>
  <!-- Menú Lateral -->
  <div id="mySidenav" class="sidenav">
    <button class="closebtn" onclick="closeNav()">&times;</button>
    <a href="#" onclick="mostrarConfiguracion()">Configuración</a>
    <a href="#" onclick="mostrarOperacionesCerradas()">Operaciones Cerradas</a>
    <a href="#" onclick="mostrarResultadosMensuales()">Resultados Mensuales</a>
    <a href="#" onclick="mostrarResultadosHistoricos()">Resultados Históricos</a>
    <a href="#" onclick="mostrarComisionesPagadas()">Comisiones Pagadas</a>
  </div>

  <!-- Botón para abrir el Menú Lateral -->
  <button class="open-sidenav-btn" onclick="openNav()"><i class="fa-solid fa-bars"></i></button>

  <!-- Botón para alternar Modo Oscuro/Claro -->
  <button class="toggle-dark-mode" onclick="toggleDarkMode()" title="Cambiar Modo">
    <i class="fa-solid fa-moon"></i>
  </button>

  <header>
    <h1>Portfolio de Inversiones</h1>
  </header>

  <main>
    <!-- Sección de Filtros -->
    <section class="filters">
      <div class="filter-group">
        <label for="monthYear">Mes/Año:</label>
        <input type="month" id="monthYear" onchange="actualizarTabla()">
      </div>

      <div class="filter-group">
        <label for="viewModeSelect">Modo de Rendimiento:</label>
        <select id="viewModeSelect" onchange="actualizarTabla()">
          <option value="DEFAULT">Default</option>
          <option value="MONTHLY">Mensual</option>
          <option value="HISTORICAL">Histórico</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="origenFilter">Origen:</label>
        <select id="origenFilter" onchange="actualizarTabla()">
          <!-- Opciones dinámicas -->
        </select>
      </div>

      <div class="filter-group">
        <label for="tipoFilter">Tipo:</label>
        <select id="tipoFilter" onchange="actualizarTabla()">
          <!-- Opciones dinámicas -->
        </select>
      </div>

      <div class="filter-group">
        <label for="monedaFilter">Moneda:</label>
        <select id="monedaFilter" onchange="actualizarTabla()">
          <!-- Opciones dinámicas -->
        </select>
      </div>
    </section>

    <!-- Sección de Acciones -->
    <section class="actions">
      <!-- Botones Arriba del Resumen -->
      <div class="actions-top">
        <button onclick="mostrarResultadosHistoricos()">Ver Rendimiento Histórico</button>
        <button onclick="mostrarResultadosMensuales()">Ver Rendimiento Mes</button>
      </div>

      <!-- Sección de Resumen -->
      <section class="summary">
        <div class="summary-box">
          <h4>Resumen en Pesos</h4>
          <div class="summary-item">
            <span class="summary-label">Total Inversión:</span>
            <span id="summaryContentPesosInversion">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Cierre Mes:</span>
            <span id="summaryContentPesosCierre">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Actual:</span>
            <span id="summaryContentPesosActual">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Diferencia:</span>
            <span id="summaryContentPesosDiferencia">-</span>
          </div>
        </div>
        <div class="summary-box">
          <h4>Resumen en Dólares</h4>
          <div class="summary-item">
            <span class="summary-label">Total Inversión:</span>
            <span id="summaryContentDolaresInversion">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Cierre Mes:</span>
            <span id="summaryContentDolaresCierre">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Actual:</span>
            <span id="summaryContentDolaresActual">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Diferencia:</span>
            <span id="summaryContentDolaresDiferencia">-</span>
          </div>
        </div>
      </section>

      <!-- Botones Debajo del Resumen -->
      <div class="actions-middle">
        <button onclick="mostrarFormulario()">Agregar Inversión</button>
        <button onclick="mostrarValoresActuales()">Ingresar Valores Actuales</button>
      </div>

      <!-- Botones Debajo con Diferente Color -->
      <div class="actions-bottom">
        <button class="export-button" onclick="exportarExcel()">Exportar Portafolio Completo a Excel</button>
        <button class="chart-button" onclick="abrirModalRendimiento()">Ver Gráfico de Rendimiento</button>
      </div>

      <!-- Botones Extra: Descargar y Subir localStorage -->
      <div class="actions-extra">
        <button onclick="descargarLocalStorage()" title="Descargar Datos">
          <i class="fa-solid fa-download"></i>
        </button>
        <button onclick="subirLocalStorage()" title="Subir Datos">
          <i class="fa-solid fa-upload"></i>
        </button>
        <!-- Input para subir archivo Excel -->
        <input type="file" id="uploadLocalStorageInput" accept=".xlsx, .xls" style="display:none" onchange="procesarArchivoLocalStorage(event)">
      </div>
    </section>

    <!-- Sección de Tablas -->
    <section class="tables">
      <!-- Tabla Principal -->
      <table>
        <thead>
          <tr>
            <th>Fecha Adquisición</th>
            <th>Nombre</th>
            <th>Moneda</th>
            <th>Q Cuotaparte</th>
            <th>Precio Compra</th>
            <th>Valor Inversión</th>
            <th>Precio Cierre Último Mes</th>
            <th>Valor Actual</th>
            <th>Diferencia</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="portfolioBody">
          <!-- Contenido dinámico -->
        </tbody>
      </table>

      <!-- Paginación -->
      <div id="paginationControls" style="display: flex; justify-content: center; margin-top: 1rem;"></div>

      <!-- Formulario para Agregar/Editar Inversión -->
      <div id="newInvestmentForm" class="form-section">
        <form id="investmentForm" onsubmit="guardarInversion(event)">
          <input type="hidden" id="editId" value="-1">
          <h3>Agregar/Editar Inversión</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="fecha">Fecha de Adquisición:</label>
              <input type="date" id="fecha" required>
            </div>
            <div class="form-group">
              <label for="nombre">Nombre de la Inversión:</label>
              <input type="text" id="nombre" required>
            </div>
            <div class="form-group">
              <label for="moneda">Moneda:</label>
              <select id="moneda" required>
                <option value="">Seleccione Moneda</option>
                <option value="PESOS">PESOS</option>
                <option value="DOLARES">DOLARES</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="cuotaparte">Q Cuotaparte:</label>
              <input type="number" id="cuotaparte" step="0.00001" required>
            </div>
            <div class="form-group">
              <label for="precio">Precio de Compra:</label>
              <input type="number" id="precio" step="0.00001" required>
            </div>
            <div class="form-group comisiones-pagadas">
              <label for="comisionesPagadas">Comisiones Pagadas:</label>
              <input type="number" id="comisionesPagadas" step="0.01" min="0" max="999999.99" placeholder="0.00">
            </div>
            <div class="form-group" style="max-width: 25ch;">
              <label for="origenInv">Origen:</label>
              <select id="origenInv" required>
                <option value="">Seleccione Origen</option>
                <!-- Opciones dinámicas -->
              </select>
            </div>
            <div class="form-group" style="max-width: 25ch;">
              <label for="tipoInv">Tipo:</label>
              <select id="tipoInv" required>
                <option value="">Seleccione Tipo</option>
                <!-- Opciones dinámicas -->
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">Guardar</button>
            <button type="button" class="btn btn-danger" onclick="cancelarInversion()">Cancelar</button>
          </div>
        </form>
      </div>

      <!-- Formulario para Procesar Venta -->
      <div id="saleForm" class="form-section">
        <form id="ventaForm" onsubmit="procesarVenta(event)">
          <input type="hidden" id="saleId" value="-1">
          <h3>Procesar Venta</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="nombreVenta">Nombre de la Inversión:</label>
              <input type="text" id="nombreVenta" readonly>
            </div>
            <div class="form-group">
              <label for="cuotaparteVenta">Q Cuotaparte a Vender:</label>
              <input type="number" id="cuotaparteVenta" step="0.00001" readonly>
            </div>
            <div class="form-group">
              <label for="tipoVenta">Tipo de Venta:</label>
              <select id="tipoVenta" onchange="toggleCuotaparteVenta()" required>
                <option value="TOTAL">Total</option>
                <option value="PARCIAL">Parcial</option>
              </select>
            </div>
            <div class="form-group">
              <label for="precioVenta">Precio de Venta:</label>
              <input type="number" id="precioVenta" step="0.00001" required>
            </div>
            <div class="form-group">
              <label for="fechaVenta">Fecha de Venta:</label>
              <input type="date" id="fechaVenta" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group comisiones-pagadas">
              <label for="comisionesPagadasVenta">Comisiones Pagadas:</label>
              <input type="number" id="comisionesPagadasVenta" step="0.01" min="0" max="999999.99" placeholder="0.00">
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">Procesar Venta</button>
            <button type="button" class="btn btn-danger" onclick="cancelarVenta()">Cancelar</button>
          </div>
        </form>
      </div>

      <!-- Formulario para Ingresar Valores Actuales Mejorado -->
      <div id="currentValuesForm" class="form-section">
        <form id="currentValuesFormContent" onsubmit="guardarValoresActuales(event)">
          <h3>Ingresar Valores Actuales</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="currentValuesMonth">Mes/Año:</label>
              <input type="month" id="currentValuesMonth" required onchange="cargarValores()">
            </div>
            <div class="form-group">
              <label for="monthClosed">Mes Cerrado:</label>
              <div class="toggle-switch">
                <input type="checkbox" id="monthClosed" onchange="toggleFieldsBasedOnClosed(this.checked)">
                <label for="monthClosed"></label>
              </div>
            </div>
          </div>
          <div class="form-row actions-row">
            <div class="form-group">
              <button type="button" class="btn btn-primary" onclick="cargarValores()">Cargar Valores</button>
            </div>
            <div class="form-group">
              <button type="button" class="btn btn-secondary" onclick="descargarTemplateValores()">Descargar Plantilla</button>
              <button type="button" class="btn btn-secondary" onclick="subirTemplateValores()">Subir Plantilla</button>
              <input type="file" id="uploadTemplateInput" accept=".xlsx, .xls" style="display:none" onchange="procesarArchivoTemplateValores(event)">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="searchInversiones">Buscar Inversión:</label>
              <input type="text" id="searchInversiones" placeholder="Escribe para buscar..." onkeyup="filtrarInversiones()">
            </div>
          </div>
          <div id="currentValuesContent">
            <!-- Campos dinámicos para cada inversión se generan aquí -->
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-success">Guardar Valores</button>
            <button type="button" class="btn btn-danger" onclick="cerrarValoresActuales()">Cancelar</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 Portfolio de Inversiones. Todos los derechos reservados.
  </footer>

  <!-- Modales Adicionales -->
  
  <!-- Configuración Modal -->
  <div id="configuracionModal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="cerrarConfiguracion()">&times;</button>
      <h3>Configuración</h3>
      <form id="configuracionForm" onsubmit="guardarConfiguracion(event)">
        <h4>Orígenes</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="configOrigenSelect">Eliminar Origen:</label>
            <select id="configOrigenSelect">
              <option value="">Seleccione Origen</option>
              <!-- Opciones dinámicas -->
            </select>
          </div>
          <div class="form-group">
            <label for="nuevoOrigen">Agregar Origen:</label>
            <input type="text" id="nuevoOrigen" placeholder="Nuevo Origen">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-primary" onclick="agregarOrigen()">Agregar Origen</button>
          <button type="button" class="btn btn-danger" onclick="eliminarOrigen()">Eliminar Origen</button>
        </div>

        <h4>Tipos</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="configTipoSelect">Eliminar Tipo:</label>
            <select id="configTipoSelect">
              <option value="">Seleccione Tipo</option>
              <!-- Opciones dinámicas -->
            </select>
          </div>
          <div class="form-group">
            <label for="nuevoTipo">Agregar Tipo:</label>
            <input type="text" id="nuevoTipo" placeholder="Nuevo Tipo">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-primary" onclick="agregarTipo()">Agregar Tipo</button>
          <button type="button" class="btn btn-danger" onclick="eliminarTipo()">Eliminar Tipo</button>
        </div>

        <h4>Monedas</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="configMonedaSelect">Eliminar Moneda:</label>
            <select id="configMonedaSelect">
              <option value="">Seleccione Moneda</option>
              <!-- Opciones dinámicas -->
            </select>
          </div>
          <div class="form-group">
            <label for="nuevoMoneda">Agregar Moneda:</label>
            <input type="text" id="nuevoMoneda" placeholder="Nueva Moneda">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-primary" onclick="agregarMoneda()">Agregar Moneda</button>
          <button type="button" class="btn btn-danger" onclick="eliminarMoneda()">Eliminar Moneda</button>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-success">Guardar Configuración</button>
          <button type="button" class="btn btn-danger" onclick="cerrarConfiguracion()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Operaciones Cerradas Modal -->
  <div id="closedOperationsModal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="cerrarModalOperaciones()">&times;</button>
      <h3>Operaciones Cerradas</h3>
      <div class="actions-extra" style="justify-content: flex-end; margin-bottom: 1rem;">
        <button class="btn btn-danger" onclick="borrarOperacionesCerradas()">Eliminar Operaciones Seleccionadas</button>
      </div>
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllClosedOps" onclick="seleccionarTodasOperaciones(this.checked)"></th>
            <th>Fecha Venta</th>
            <th>Nombre</th>
            <th>Moneda</th>
            <th>Q Cuotaparte</th>
            <th>Precio Compra</th>
            <th>Precio Venta</th>
            <th>Comisiones Pagadas</th>
            <th>Valor a Reinvertir</th>
            <th>Rendimiento</th>
          </tr>
        </thead>
        <tbody id="closedOperationsBody">
          <!-- Contenido dinámico -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Resultados Históricos Modal -->
  <div id="historicalResultsModal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="cerrarResultadosHistoricos()">&times;</button>
      <h3>Resultados Históricos</h3>
      <div id="historicalResultsContent">
        <!-- Contenido dinámico -->
      </div>
    </div>
  </div>

  <!-- Comisiones Pagadas Modal -->
  <div id="comisionesPagadasModal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="cerrarComisionesPagadas()">&times;</button>
      <h3>Comisiones Pagadas</h3>
      <div id="comisionesPagadasContent">
        <!-- Contenido dinámico -->
      </div>
    </div>
  </div>

  <!-- Gráfico Rendimiento Modal -->
  <div id="rendimientoModal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="cerrarGraficoRendimiento()">&times;</button>
      <h3>Gráfico de Rendimiento</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="monthYearRendimiento">Mes/Año:</label>
          <input type="month" id="monthYearRendimiento" onchange="generarGraficoRendimiento()">
        </div>
        <div class="form-group">
          <label for="toggleChartMode">Modo:</label>
          <div style="display: flex; align-items: center;">
            <input type="checkbox" id="toggleChartMode" onchange="generarGraficoRendimiento()">
            <label id="toggleChartLabel" for="toggleChartMode" style="margin-left: 0.5rem;">Histórico</label>
          </div>
        </div>
      </div>
      <div class="rendimiento-charts-container">
        <div class="chart-wrapper">
          <canvas id="chartPesos" width="400" height="400"></canvas>
          <div class="chart-legend" id="legendPesos"></div>
        </div>
        <div class="chart-wrapper">
          <canvas id="chartDolares" width="400" height="400"></canvas>
          <div class="chart-legend" id="legendDolares"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resultados Mensuales Modal -->
  <div id="monthlyResultsModal" class="modal">
    <div class="modal-content">
      <button class="close-button" onclick="cerrarResultadosMensuales()">&times;</button>
      <h3>Resultados Mensuales</h3>
      <div id="monthlyResultsContent">
        <!-- Contenido dinámico -->
      </div>
    </div>
  </div>

  <!-- Toast Container para Notificaciones -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
    <!-- Toastes se generan dinámicamente -->
  </div>

  <!-- AQUÍ COMIENZA TODO EL JAVASCRIPT DE LA APLICACIÓN -->
  <script>
    /**************************************************************
     * REGISTRO DE PLUGINS DE CHART.JS
     **************************************************************/
    Chart.register(ChartDataLabels);

    /**************************************************************
     * VARIABLES GLOBALES
     **************************************************************/
    let inversiones = [];
    let operacionesCerradas = [];
    let valoresMensuales = {};

    let configOrigen = [];
    let configTipo = [];
    let configMoneda = [];

    let totalesGlobal = null;

    // Variables para los gráficos
    let doughnutPesos = null;
    let doughnutDolares = null;

    // Colores para flechas, etc.
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success').trim();
    const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger').trim();

    // ID Autoincremental para inversiones
    let nextInvestmentId = 1;

    /**************************************************************
     * UTILIDADES
     **************************************************************/
    function escapeHTML(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    function formatNumber(num, decimals = 5) {
      return Number(num).toFixed(decimals);
    }
    function formatCurrency(num, moneda='PESOS', decimals = 2) {
      if (num === '-' || isNaN(num)) return '0';
      const options = { minimumFractionDigits: decimals, maximumFractionDigits: decimals };
      const f = new Intl.NumberFormat('es-AR', options).format(num);
      return (moneda === 'DOLARES') ? 'U$D ' + f : '$ ' + f;
    }
    function calculatePercentage(actual, original) {
      if (!original || original === 0) return null;
      return ((actual - original) / original * 100).toFixed(2);
    }
    function getDifferenceArrow(isPositive) {
      const arrowPath = isPositive ? 'M6 1l5 5H1l5-5' : 'M6 11L1 6h10l-5 5';
      const fillColor = isPositive ? successColor : dangerColor;
      return `<svg width="12" height="12" viewBox="0 0 12 12" style="display:inline-block; margin-left:4px;">
                <path d="${arrowPath}" fill="${fillColor}"/>
              </svg>`;
    }

    function getPreviousMonth(currentMonth) {
      const [year, month] = currentMonth.split('-').map(Number);
      let prevYear = year;
      let prevMonth = month - 1;
      if (prevMonth < 1) { prevMonth = 12; prevYear--; }
      return `${prevYear}-${prevMonth < 10 ? '0' + prevMonth : prevMonth}`;
    }
    function calcularDiasDesdeHoy(fecha) {
      const hoy = new Date();
      const fechaInv = new Date(fecha);
      const diffMs = hoy - fechaInv;
      const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      return diffDias;
    }

    /**************************************************************
     * LOCAL STORAGE
     **************************************************************/
    function cargarDatos(){
      const storedInversiones = JSON.parse(localStorage.getItem('inversiones'));
      const storedOperaciones = JSON.parse(localStorage.getItem('operacionesCerradas'));
      const storedValores = JSON.parse(localStorage.getItem('valoresMensuales'));
      const storedOrigen = JSON.parse(localStorage.getItem('configOrigen'));
      const storedTipo = JSON.parse(localStorage.getItem('configTipo'));
      const storedMoneda = JSON.parse(localStorage.getItem('configMoneda'));
      const storedNextId = JSON.parse(localStorage.getItem('nextInvestmentId'));

      if(storedInversiones) {
        inversiones = storedInversiones;
        // Verificar y asignar ID si faltan
        inversiones.forEach(inv => {
          if(!inv.id){
            inv.id = nextInvestmentId++;
          }
        });
      }
      if(storedOperaciones) operacionesCerradas = storedOperaciones;
      if(storedValores) valoresMensuales = storedValores;
      if(storedOrigen && storedOrigen.length > 0) configOrigen = storedOrigen;
      if(storedTipo && storedTipo.length > 0) configTipo = storedTipo;
      if(storedMoneda && storedMoneda.length > 0) configMoneda = storedMoneda;
      if(storedNextId && storedNextId > nextInvestmentId) nextInvestmentId = storedNextId;

      // Si se asignaron nuevos IDs, guardar los cambios
      if(storedInversiones){
        localStorage.setItem('inversiones', JSON.stringify(inversiones));
        localStorage.setItem('nextInvestmentId', JSON.stringify(nextInvestmentId));
      }
    }
    function guardarDatos(){
      localStorage.setItem('inversiones', JSON.stringify(inversiones));
      localStorage.setItem('operacionesCerradas', JSON.stringify(operacionesCerradas));
      localStorage.setItem('valoresMensuales', JSON.stringify(valoresMensuales));
      localStorage.setItem('configOrigen', JSON.stringify(configOrigen));
      localStorage.setItem('configTipo', JSON.stringify(configTipo));
      localStorage.setItem('configMoneda', JSON.stringify(configMoneda));
      localStorage.setItem('nextInvestmentId', JSON.stringify(nextInvestmentId));
    }

    /**************************************************************
     * SELECTS & CONFIG
     **************************************************************/
    function actualizarSelects(){
      const origenFilter = document.getElementById('origenFilter');
      const origenInv = document.getElementById('origenInv');
      const tipoFilter = document.getElementById('tipoFilter');
      const tipoInv = document.getElementById('tipoInv');
      const monedaFilter = document.getElementById('monedaFilter');
      const moneda = document.getElementById('moneda');

      origenFilter.innerHTML = '<option value="">Todos</option>';
      origenInv.innerHTML = '<option value="">Seleccione Origen</option>';
      tipoFilter.innerHTML = '<option value="">Todos</option>';
      tipoInv.innerHTML = '<option value="">Seleccione Tipo</option>';
      monedaFilter.innerHTML = '<option value="">Todos</option>';
      moneda.innerHTML = '<option value="">Seleccione Moneda</option>';

      configOrigen.forEach(o => {
        const optF = document.createElement('option');
        optF.value = o; optF.textContent = o;
        origenFilter.appendChild(optF);

        const optI = document.createElement('option');
        optI.value = o; optI.textContent = o;
        origenInv.appendChild(optI);
      });

      configTipo.forEach(t => {
        const optF = document.createElement('option');
        optF.value = t; optF.textContent = t;
        tipoFilter.appendChild(optF);

        const optI = document.createElement('option');
        optI.value = t; optI.textContent = t;
        tipoInv.appendChild(optI);
      });

      configMoneda.forEach(m => {
        const optF = document.createElement('option');
        optF.value = m; optF.textContent = m;
        monedaFilter.appendChild(optF);

        const optI = document.createElement('option');
        optI.value = m; optI.textContent = m;
        moneda.appendChild(optI);
      });
    }

    /**************************************************************
     * MENÚ LATERAL
     **************************************************************/
    function openNav() {
      document.getElementById("mySidenav").style.width = "250px";
      document.querySelector('main').style.marginLeft = "250px";
    }

    function closeNav() {
      document.getElementById("mySidenav").style.width = "0";
      document.querySelector('main').style.marginLeft= "0";
    }

    /**************************************************************
     * CONFIGURACIÓN MODAL
     **************************************************************/
    function mostrarConfiguracion(){
      actualizarConfigModal();
      abrirConfiguracionModal();
    }

    function actualizarConfigModal(){
      const configOrigenSelect = document.getElementById('configOrigenSelect');
      const configTipoSelect = document.getElementById('configTipoSelect');
      const configMonedaSelect = document.getElementById('configMonedaSelect');

      configOrigenSelect.innerHTML = '<option value="">Seleccione Origen</option>';
      configTipoSelect.innerHTML = '<option value="">Seleccione Tipo</option>';
      configMonedaSelect.innerHTML = '<option value="">Seleccione Moneda</option>';

      configOrigen.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o; opt.textContent = o;
        configOrigenSelect.appendChild(opt);
      });

      configTipo.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t;
        configTipoSelect.appendChild(opt);
      });

      configMoneda.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = m;
        configMonedaSelect.appendChild(opt);
      });
    }

    function abrirConfiguracionModal(){
      document.getElementById('configuracionModal').classList.add('visible');
      closeNav();
    }

    function cerrarConfiguracion(){
      document.getElementById('configuracionModal').classList.remove('visible');
      document.getElementById('configuracionForm').reset();
    }

    function agregarOrigen(){
      const nuevoOrigen = document.getElementById('nuevoOrigen').value.trim().toUpperCase();
      if(nuevoOrigen === ''){
        mostrarToast('Ingrese un origen válido.', 'danger');
        return;
      }
      if(configOrigen.includes(nuevoOrigen)){
        mostrarToast('El origen ya existe.', 'danger');
        return;
      }
      configOrigen.push(nuevoOrigen);
      actualizarSelects();
      actualizarConfigModal();
      document.getElementById('nuevoOrigen').value = '';
      mostrarToast('Origen agregado exitosamente.', 'success');
    }

    function eliminarOrigen(){
      const selectedOrigen = document.getElementById('configOrigenSelect').value;
      if(selectedOrigen === ''){
        mostrarToast('Seleccione un origen para eliminar.', 'warning');
        return;
      }
      if(confirm(`¿Está seguro de eliminar el origen "${selectedOrigen}"?`)){
        configOrigen = configOrigen.filter(o => o !== selectedOrigen);
        actualizarSelects();
        actualizarConfigModal();
        mostrarToast('Origen eliminado exitosamente.', 'success');
      }
    }

    function agregarTipo(){
      const nuevoTipo = document.getElementById('nuevoTipo').value.trim().toUpperCase();
      if(nuevoTipo === ''){
        mostrarToast('Ingrese un tipo válido.', 'danger');
        return;
      }
      if(configTipo.includes(nuevoTipo)){
        mostrarToast('El tipo ya existe.', 'danger');
        return;
      }
      configTipo.push(nuevoTipo);
      actualizarSelects();
      actualizarConfigModal();
      document.getElementById('nuevoTipo').value = '';
      mostrarToast('Tipo agregado exitosamente.', 'success');
    }

    function eliminarTipo(){
      const selectedTipo = document.getElementById('configTipoSelect').value;
      if(selectedTipo === ''){
        mostrarToast('Seleccione un tipo para eliminar.', 'warning');
        return;
      }
      if(confirm(`¿Está seguro de eliminar el tipo "${selectedTipo}"?`)){
        configTipo = configTipo.filter(t => t !== selectedTipo);
        actualizarSelects();
        actualizarConfigModal();
        mostrarToast('Tipo eliminado exitosamente.', 'success');
      }
    }

    function agregarMoneda(){
      const nuevaMoneda = document.getElementById('nuevoMoneda').value.trim().toUpperCase();
      if(nuevaMoneda === ''){
        mostrarToast('Ingrese una moneda válida.', 'danger');
        return;
      }
      if(configMoneda.includes(nuevaMoneda)){
        mostrarToast('La moneda ya existe.', 'danger');
        return;
      }
      configMoneda.push(nuevaMoneda);
      actualizarSelects();
      actualizarConfigModal();
      document.getElementById('nuevoMoneda').value = '';
      mostrarToast('Moneda agregada exitosamente.', 'success');
    }

    function eliminarMoneda(){
      const selectedMoneda = document.getElementById('configMonedaSelect').value;
      if(selectedMoneda === ''){
        mostrarToast('Seleccione una moneda para eliminar.', 'warning');
        return;
      }
      if(confirm(`¿Está seguro de eliminar la moneda "${selectedMoneda}"?`)){
        configMoneda = configMoneda.filter(m => m !== selectedMoneda);
        actualizarSelects();
        actualizarConfigModal();
        mostrarToast('Moneda eliminada exitosamente.', 'success');
      }
    }

    function guardarConfiguracion(e){
      e.preventDefault();
      guardarDatos();
      mostrarToast('Configuración guardada exitosamente.', 'success');
      cerrarConfiguracion();
    }

    /**************************************************************
     * MODO OSCURO
     **************************************************************/
    function toggleDarkMode(){
      document.body.classList.toggle('dark-mode');
      const toggleBtn = document.querySelector('.toggle-dark-mode i');
      if(document.body.classList.contains('dark-mode')){
        toggleBtn.classList.remove('fa-moon');
        toggleBtn.classList.add('fa-sun');
      } else{
        toggleBtn.classList.remove('fa-sun');
        toggleBtn.classList.add('fa-moon');
      }
    }

    /**************************************************************
     * MODO: MENSUAL / HISTÓRICO / DEFAULT (para la tabla principal)
     **************************************************************/
    function getPrecioCompraMensual(inv, selectedMonth){
      const invMonth = inv.fecha.slice(0,7);
      if(invMonth === selectedMonth){
        return valoresMensuales[selectedMonth]?.values[inv.id] || inv.precio;
      } else{
        const prevMonth = getPreviousMonth(selectedMonth);
        const valAnterior = valoresMensuales[prevMonth]?.values[inv.id];
        return (valAnterior && valAnterior > 0) ? valAnterior : inv.precio;
      }
    }
    function getPrecioCompraHistorico(inv, selectedMonth){
      // Históricamente, tomamos su precio de compra original
      return inv.precio;
    }

    /**************************************************************
     * ACTUALIZAR TABLA & RESUMEN
     **************************************************************/
    function actualizarTabla(){
      const tbody = document.getElementById('portfolioBody');
      const filtroMoneda = document.getElementById('monedaFilter').value;
      const filtroTipo = document.getElementById('tipoFilter').value;
      const filtroOrigen = document.getElementById('origenFilter').value;
      const selectedMonth = document.getElementById('monthYear').value;
      const viewMode = document.getElementById('viewModeSelect').value;

      tbody.innerHTML = '';

      let filtradas = inversiones.filter(inv => inv.cuotaparte > 0);

      if(filtroMoneda){
        filtradas = filtradas.filter(inv => inv.moneda === filtroMoneda);
      }
      if(filtroTipo){
        filtradas = filtradas.filter(inv => inv.tipo === filtroTipo);
      }
      if(filtroOrigen){
        filtradas = filtradas.filter(inv => inv.origen === filtroOrigen);
      }
      if(selectedMonth){
        filtradas = filtradas.filter(inv => inv.fecha.slice(0,7) <= selectedMonth);
      }

      // Optimización para grandes cantidades de inversiones: paginación simple
      const itemsPerPage = 10;
      const currentPage = parseInt(document.getElementById('currentPage')?.value) || 1;
      const totalPages = Math.ceil(filtradas.length / itemsPerPage);
      const startIdx = (currentPage - 1) * itemsPerPage;
      const endIdx = startIdx + itemsPerPage;
      const paginatedInversiones = filtradas.slice(startIdx, endIdx);

      paginatedInversiones.forEach(inv => {
        let precioCompraBase = inv.precio;   // Valor base
        let valorInversion = inv.cuotaparte * inv.precio; // default
        let valorCargado = 0;
        let valorActual = '-';
        let diferencia = '-';
        let porcentaje = null;

        if(viewMode === 'MONTHLY' && selectedMonth && valoresMensuales[selectedMonth]?.closed){
          // Modo Mensual
          valorCargado = valoresMensuales[selectedMonth].values[inv.id] || 0;
          precioCompraBase = getPrecioCompraMensual(inv, selectedMonth);
          valorInversion = inv.cuotaparte * precioCompraBase;
          if(valorCargado > 0){
            valorActual = inv.cuotaparte * valorCargado;
            diferencia = valorActual - valorInversion;
            porcentaje = calculatePercentage(valorActual, valorInversion);
          }
        }
        else if(viewMode === 'HISTORICAL' && selectedMonth && valoresMensuales[selectedMonth]?.closed){
          // Modo Histórico
          precioCompraBase = getPrecioCompraHistorico(inv, selectedMonth);
          valorCargado = valoresMensuales[selectedMonth].values[inv.id] || 0;
          valorInversion = inv.cuotaparte * inv.precio;
          if(valorCargado > 0){
            valorActual = inv.cuotaparte * valorCargado;
            diferencia = valorActual - valorInversion;
            porcentaje = calculatePercentage(valorActual, valorInversion);
          }
        }
        else {
          // Modo DEFAULT
          if(inv.valorActual && inv.valorActual > 0) {
            valorActual = inv.cuotaparte * inv.valorActual;
          } else {
            valorActual = inv.cuotaparte * inv.precio;
          }
          diferencia = valorActual - valorInversion;
          porcentaje = calculatePercentage(valorActual, valorInversion);
        }

        const diffCell = (diferencia !== '-' && diferencia !== null)
          ? (formatCurrency(Math.abs(diferencia), inv.moneda, 2) +
             (porcentaje ? ` (${Math.abs(porcentaje)}%)` : '') +
             (diferencia >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false)))
          : '-';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(inv.fecha)}</td>
          <td>${escapeHTML(inv.nombre)}</td>
          <td>${escapeHTML(inv.moneda)}</td>
          <td class="number-cell">${formatNumber(inv.cuotaparte, 5)}</td>
          <td class="number-cell">${formatNumber(precioCompraBase, 5)}</td>
          <td class="number-cell">${formatCurrency(valorInversion, inv.moneda, 2)}</td>
          <td class="number-cell">
            ${
              (viewMode === 'MONTHLY' && valorCargado > 0) 
                ? formatCurrency(inv.cuotaparte * valorCargado, inv.moneda, 2) 
                : '-'
            }
          </td>
          <td class="number-cell">
            ${
              valorActual !== '-' 
                ? formatCurrency(valorActual, inv.moneda, 2) 
                : '-'
            }
          </td>
          <td class="number-cell" style="color:${diferencia >= 0 ? successColor : dangerColor};">
            ${diffCell}
          </td>
          <td class="acciones">
            <div class="btn-group">
              <button class="btn btn-edit" title="Editar" onclick="editarInversionPorID('${inv.id}')">
                <i class="fa-solid fa-pen-to-square"></i>
              </button>
              <button class="btn btn-sell" title="Vender" onclick="venderInversionPorID('${inv.id}', event)">
                <i class="fa-solid fa-sack-dollar"></i>
              </button>
            </div>
            <button class="btn btn-delete" title="Eliminar" onclick="eliminarInversionPorID('${inv.id}')">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Paginación
      agregarPaginacion(filtradas.length, itemsPerPage, currentPage);

      actualizarResumen(filtradas);
      guardarDatos();
    }

    function agregarPaginacion(totalItems, itemsPerPage, currentPage){
      const mainSection = document.querySelector('.tables');
      let pagination = document.getElementById('paginationControls');
      if(!pagination){
        pagination = document.createElement('div');
        pagination.id = 'paginationControls';
        pagination.style.display = 'flex';
        pagination.style.justifyContent = 'center';
        pagination.style.marginTop = '1rem';
        mainSection.appendChild(pagination);
      }
      pagination.innerHTML = '';

      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if(totalPages <=1 ) return;

      // Botón Anterior
      const prevBtn = document.createElement('button');
      prevBtn.className = 'btn btn-secondary';
      prevBtn.innerText = 'Anterior';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => cambiarPagina(currentPage - 1);
      pagination.appendChild(prevBtn);

      // Botones de Página
      for(let i=1; i<= totalPages; i++){
        const pageBtn = document.createElement('button');
        pageBtn.className = 'btn btn-primary';
        pageBtn.innerText = i;
        if(i === currentPage){
          pageBtn.disabled = true;
        }
        pageBtn.onclick = () => cambiarPagina(i);
        pagination.appendChild(pageBtn);
      }

      // Botón Siguiente
      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn btn-secondary';
      nextBtn.innerText = 'Siguiente';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => cambiarPagina(currentPage + 1);
      pagination.appendChild(nextBtn);
    }

    function cambiarPagina(nuevaPagina){
      if(nuevaPagina < 1 || nuevaPagina > Math.ceil(inversiones.length / 10)) return;
      // Crear un input oculto para almacenar la página actual
      let currentPageInput = document.getElementById('currentPage');
      if(!currentPageInput){
        currentPageInput = document.createElement('input');
        currentPageInput.type = 'hidden';
        currentPageInput.id = 'currentPage';
        currentPageInput.value = nuevaPagina;
        document.body.appendChild(currentPageInput);
      } else{
        currentPageInput.value = nuevaPagina;
      }
      actualizarTabla();
    }

    function actualizarResumen(listaFiltrada){
      const summaryPesosInversion = document.getElementById('summaryContentPesosInversion');
      const summaryPesosCierre = document.getElementById('summaryContentPesosCierre');
      const summaryPesosActual = document.getElementById('summaryContentPesosActual');
      const summaryPesosDiferencia = document.getElementById('summaryContentPesosDiferencia');

      const summaryDolaresInversion = document.getElementById('summaryContentDolaresInversion');
      const summaryDolaresCierre = document.getElementById('summaryContentDolaresCierre');
      const summaryDolaresActual = document.getElementById('summaryContentDolaresActual');
      const summaryDolaresDiferencia = document.getElementById('summaryContentDolaresDiferencia');

      const selectedMonth = document.getElementById('monthYear').value;
      const viewMode = document.getElementById('viewModeSelect').value;

      let totales = {
        PESOS: {valorInversion: 0, valorCierreMes: 0, valorActual: 0},
        DOLARES: {valorInversion: 0, valorCierreMes: 0, valorActual: 0}
      };

      listaFiltrada.forEach(inv => {
        let valorInversion = inv.cuotaparte * inv.precio; 
        let invActual = 0;

        if(viewMode === 'MONTHLY' && selectedMonth && valoresMensuales[selectedMonth]?.closed) {
          // Modo Mensual
          const valorCargado = valoresMensuales[selectedMonth].values[inv.id] || 0;
          const precioCompraBase = getPrecioCompraMensual(inv, selectedMonth);
          valorInversion = inv.cuotaparte * precioCompraBase;
          if(valorCargado > 0){
            invActual = inv.cuotaparte * valorCargado;
            totales[inv.moneda].valorCierreMes += invActual; 
          }
        }
        else if(viewMode === 'HISTORICAL' && selectedMonth && valoresMensuales[selectedMonth]?.closed) {
          // Modo Histórico
          const valorCargado = valoresMensuales[selectedMonth].values[inv.id] || 0;
          // Su "inversión" base es su precio de compra original
          valorInversion = inv.cuotaparte * inv.precio;
          if(valorCargado > 0){
            invActual = inv.cuotaparte * valorCargado;
            totales[inv.moneda].valorCierreMes += invActual;
          }
        }
        else {
          // Modo DEFAULT
          // Toma valorActual si existe, si no usa inv.precio
          if(inv.valorActual && inv.valorActual > 0) {
            invActual = inv.cuotaparte * inv.valorActual;
          } else {
            invActual = inv.cuotaparte * inv.precio;
          }
          // Cierre mes (en DEFAULT no lo calculamos), quedará en 0
        }

        totales[inv.moneda].valorInversion += valorInversion;
        totales[inv.moneda].valorActual += invActual;
      });

      // PESOS
      const difPes = totales.PESOS.valorActual - totales.PESOS.valorInversion;
      const pctPes = calculatePercentage(totales.PESOS.valorActual, totales.PESOS.valorInversion);

      summaryPesosInversion.innerHTML = formatCurrency(totales.PESOS.valorInversion, 'PESOS', 2);
      summaryPesosCierre.innerHTML = formatCurrency(totales.PESOS.valorCierreMes, 'PESOS', 2);
      summaryPesosActual.innerHTML = formatCurrency(totales.PESOS.valorActual, 'PESOS', 2);
      summaryPesosDiferencia.innerHTML = difPes !== 0
        ? formatCurrency(Math.abs(difPes), 'PESOS', 2) +
          (pctPes ? ` (${Math.abs(pctPes)}%)` : '') +
          (difPes >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false))
        : '-';

      // DOLARES
      const difDol = totales.DOLARES.valorActual - totales.DOLARES.valorInversion;
      const pctDol = calculatePercentage(totales.DOLARES.valorActual, totales.DOLARES.valorInversion);

      summaryDolaresInversion.innerHTML = formatCurrency(totales.DOLARES.valorInversion, 'DOLARES', 2);
      summaryDolaresCierre.innerHTML = formatCurrency(totales.DOLARES.valorCierreMes, 'DOLARES', 2);
      summaryDolaresActual.innerHTML = formatCurrency(totales.DOLARES.valorActual, 'DOLARES', 2);
      summaryDolaresDiferencia.innerHTML = difDol !== 0
        ? formatCurrency(Math.abs(difDol), 'DOLARES', 2) +
          (pctDol ? ` (${Math.abs(pctDol)}%)` : '') +
          (difDol >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false))
        : '-';

      totalesGlobal = totales;
    }

    /**************************************************************
     * FORMULARIO INVERSIÓN
     **************************************************************/
    function mostrarFormulario(){
      document.getElementById('editId').value = -1;
      document.getElementById('investmentForm').reset();
      document.getElementById('newInvestmentForm').classList.add('visible');
      window.scrollTo(0, 0);
    }
    function cancelarInversion(){
      document.getElementById('newInvestmentForm').classList.remove('visible');
      document.getElementById('investmentForm').reset();
    }
    function guardarInversion(e){
      e.preventDefault();
      const fecha = document.getElementById('fecha').value;
      const nombre = document.getElementById('nombre').value.trim();
      const moneda = document.getElementById('moneda').value;
      const cuotaparte = parseFloat(document.getElementById('cuotaparte').value);
      const precio = parseFloat(document.getElementById('precio').value);
      const origen = document.getElementById('origenInv').value;
      const tipo = document.getElementById('tipoInv').value;
      const comisionesPagadas = parseFloat(document.getElementById('comisionesPagadas').value) || 0;

      if(!fecha || !nombre || !moneda || !origen || !tipo || isNaN(cuotaparte) || isNaN(precio)){
        mostrarToast('Por favor, complete todos los campos correctamente.', 'warning');
        return;
      }

      if(cuotaparte <= 0 || precio <= 0){
        mostrarToast('Q Cuotaparte y Precio de Compra deben ser números positivos.', 'warning');
        return;
      }

      const editId = document.getElementById('editId').value;
      if(editId >= 0){
        // Actualizar inversión existente
        const index = inversiones.findIndex(inv => inv.id == editId);
        if(index !== -1){
          inversiones[index].fecha = fecha;
          inversiones[index].nombre = nombre;
          inversiones[index].moneda = moneda;
          inversiones[index].cuotaparte = cuotaparte;
          inversiones[index].precio = precio;
          inversiones[index].origen = origen;
          inversiones[index].tipo = tipo;
          inversiones[index].comisionesPagadas = comisionesPagadas;
        }

        // Actualizar valores mensuales relacionados
        Object.keys(valoresMensuales).forEach(month => {
          if(valoresMensuales[month].values[editId]){
            valoresMensuales[month].values[editId] = inversiones[index]?.valorActual || 0;
          }
        });

      } else{
        // Crear nueva inversión con ID único
        const nuevaInversion = {
          id: nextInvestmentId++,
          fecha,
          nombre,
          moneda,
          cuotaparte,
          precio,
          origen,
          tipo,
          comisionesPagadas,
          valorActual: 0
        };
        inversiones.push(nuevaInversion);
      }
      actualizarTabla();
      cancelarInversion();
      mostrarToast('Inversión guardada exitosamente.', 'success');
      guardarDatos();
    }
    function editarInversionPorID(id){
      const inv = inversiones.find(inv => inv.id == id);
      if(!inv){
        mostrarToast('Inversión no encontrada.', 'danger');
        return;
      }
      document.getElementById('fecha').value = inv.fecha;
      document.getElementById('nombre').value = inv.nombre;
      document.getElementById('moneda').value = inv.moneda;
      document.getElementById('cuotaparte').value = inv.cuotaparte;
      document.getElementById('precio').value = inv.precio;
      document.getElementById('origenInv').value = inv.origen;
      document.getElementById('tipoInv').value = inv.tipo;
      document.getElementById('comisionesPagadas').value = inv.comisionesPagadas;
      document.getElementById('editId').value = inv.id;
      document.getElementById('newInvestmentForm').classList.add('visible');
      window.scrollTo(0, 0);
    }
    function eliminarInversionPorID(id){
      if(confirm('¿Está seguro de eliminar esta inversión?')){
        const index = inversiones.findIndex(inv => inv.id == id);
        if(index !== -1){
          const nombreEliminado = inversiones[index].nombre;
          inversiones.splice(index,1);

          // Eliminar operaciones cerradas relacionadas
          operacionesCerradas = operacionesCerradas.filter(op => op.id !== id);

          // Eliminar valores mensuales relacionados
          Object.keys(valoresMensuales).forEach(month => {
            if(valoresMensuales[month].values[id]){
              delete valoresMensuales[month].values[id];
            }
          });

          actualizarTabla();
          mostrarToast('Inversión eliminada exitosamente.', 'success');
        } else{
          mostrarToast('Inversión no encontrada.', 'danger');
        }
      }
    }

    /**************************************************************
     * FORMULARIO VALORES ACTUALES
     **************************************************************/
    function mostrarValoresActuales(){
      // Mostrar el formulario sin exigir mes/año al abrir
      const form = document.getElementById('currentValuesForm');
      form.classList.add('visible');
      window.scrollTo(0, 0);

      // Limpiar campos previos (opcional)
      document.getElementById('currentValuesContent').innerHTML = '';
      document.getElementById('monthClosed').checked = false;
      document.getElementById('currentValuesMonth').value = '';
      document.getElementById('searchInversiones').value = '';
      document.querySelector('.form-actions .btn-success').disabled = false;
    }
    function cerrarValoresActuales(){
      document.getElementById('currentValuesForm').classList.remove('visible');
      document.getElementById('currentValuesFormContent').reset();
      document.getElementById('currentValuesContent').innerHTML = '';
      document.getElementById('searchInversiones').value = '';
      document.querySelector('.form-actions .btn-success').disabled = false;
    }
    function toggleFieldsBasedOnClosed(isClosed){
      const container = document.getElementById('currentValuesContent');
      const inputs = container.querySelectorAll('input[type="number"]');
      inputs.forEach(inp => {
        if(isClosed){
          inp.readOnly = true;
          inp.style.backgroundColor = '#f5f5f5';
        } else{
          inp.readOnly = false;
          inp.style.backgroundColor = '';
        }
      });
    }
    function cargarValores(){
      const form = document.getElementById('currentValuesFormContent');
      const monthKey = document.getElementById('currentValuesMonth').value;

      if(!monthKey){
        mostrarToast('Por favor, seleccione un mes/año.', 'warning');
        return;
      }
      const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) <= monthKey);
      if(invMes.length === 0){
        mostrarToast('No hay inversiones vigentes hasta el mes seleccionado.', 'warning');
        return;
      }

      const container = document.getElementById('currentValuesContent');
      container.innerHTML = '';

      invMes.forEach(inv => {
        const existingValue = valoresMensuales[monthKey]?.values[inv.id];
        container.innerHTML += `
          <div class="form-row">
            <div class="form-group">
              <label for="valorActual_${escapeHTML(inv.id)}">${escapeHTML(inv.nombre)}:</label>
              <input type="number" id="valorActual_${escapeHTML(inv.id)}"
                     step="0.00001"
                     value="${existingValue !== undefined ? existingValue.toFixed(5) : ''}"
                     placeholder="Ingrese valor actual">
            </div>
          </div>
        `;
      });

      const isClosed = valoresMensuales[monthKey]?.closed || false;
      document.getElementById('monthClosed').checked = isClosed;
      toggleFieldsBasedOnClosed(isClosed);
    }
    function filtrarInversiones(){
      const searchTerm = document.getElementById('searchInversiones').value.toLowerCase();
      const container = document.getElementById('currentValuesContent');
      const rows = container.querySelectorAll('.form-row');

      rows.forEach(row => {
        const label = row.querySelector('label').textContent.toLowerCase();
        if(label.includes(searchTerm)){
          row.style.display = '';
        } else{
          row.style.display = 'none';
        }
      });
    }
    function guardarValoresActuales(e){
      e.preventDefault();
      const monthKey = document.getElementById('currentValuesMonth').value;
      const isClosed = document.getElementById('monthClosed').checked;

      if(!monthKey){
        mostrarToast('Por favor, seleccione un mes/año.', 'warning');
        return;
      }
      const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) <= monthKey);
      if(invMes.length === 0){
        mostrarToast('No hay inversiones vigentes hasta el mes seleccionado.', 'warning');
        return;
      }

      if(!valoresMensuales[monthKey]){
        valoresMensuales[monthKey] = {closed: isClosed, values: {}};
      }
      valoresMensuales[monthKey].closed = isClosed;

      const invFiltradas = inversiones.filter(inv => inv.fecha.slice(0,7) <= monthKey);
      let allValid = true;
      invFiltradas.forEach(inv => {
        const input = document.getElementById(`valorActual_${escapeHTML(inv.id)}`);
        if(input){
          const val = parseFloat(input.value);
          if(isNaN(val) || val <= 0){
            allValid = false;
            input.style.borderColor = 'var(--danger)';
          } else{
            input.style.borderColor = '#ccc';
            valoresMensuales[monthKey].values[inv.id] = parseFloat(val.toFixed(5)); // Hasta 5 decimales
            inv.valorActual = val;
          }
        }
      });

      if(!allValid){
        mostrarToast('Por favor, corrige los valores inválidos.', 'danger');
        return;
      }

      actualizarTabla();
      cerrarValoresActuales();
      mostrarToast('Valores actuales guardados correctamente.', 'success');
      guardarDatos();
    }

    /**************************************************************
     * EXPORTAR EXCEL
     **************************************************************/
    function exportarExcel(){
      const wb = XLSX.utils.book_new();
      const selectedMonth = document.getElementById('monthYear').value;
      const viewMode = document.getElementById('viewModeSelect').value;

      // Tabla Principal
      const portPesos = [["Fecha Adquisición","Nombre","Moneda","Q cuotaparte","Precio Compra","Valor Inversión","Precio Cierre Último Mes","Valor Actual","Diferencia"]];
      const portDolares = [["Fecha Adquisición","Nombre","Moneda","Q cuotaparte","Precio Compra","Valor Inversión","Precio Cierre Último Mes","Valor Actual","Diferencia"]];

      inversiones.forEach(inv => {
        let precioCompraBase = inv.precio;
        let valorInversion = inv.cuotaparte * inv.precio;
        let valorCargado = 0;
        let valorActual = '-';
        let diferencia = '-';
        let porcentaje = null;

        if(viewMode === 'MONTHLY' && selectedMonth && valoresMensuales[selectedMonth]?.closed){
          // Modo Mensual
          valorCargado = valoresMensuales[selectedMonth].values[inv.id] || 0;
          precioCompraBase = getPrecioCompraMensual(inv, selectedMonth);
          valorInversion = inv.cuotaparte * precioCompraBase;
          if(valorCargado > 0){
            valorActual = inv.cuotaparte * valorCargado;
            diferencia = valorActual - valorInversion;
            porcentaje = calculatePercentage(valorActual, valorInversion);
          }
        }
        else if(viewMode === 'HISTORICAL' && selectedMonth && valoresMensuales[selectedMonth]?.closed){
          // Modo Histórico
          precioCompraBase = getPrecioCompraHistorico(inv, selectedMonth);
          valorCargado = valoresMensuales[selectedMonth].values[inv.id] || 0;
          valorInversion = inv.cuotaparte * inv.precio;
          if(valorCargado > 0){
            valorActual = inv.cuotaparte * valorCargado;
            diferencia = valorActual - valorInversion;
            porcentaje = calculatePercentage(valorActual, valorInversion);
          }
        }
        else {
          // Modo DEFAULT
          if(inv.valorActual && inv.valorActual > 0) {
            valorActual = inv.cuotaparte * inv.valorActual;
          } else {
            valorActual = inv.cuotaparte * inv.precio;
          }
          diferencia = valorActual - valorInversion;
          porcentaje = calculatePercentage(valorActual, valorInversion);
        }

        const difValue = (diferencia !== '-' && diferencia !== null) ? diferencia : '-';
        const row = [
          inv.fecha,
          inv.nombre,
          inv.moneda,
          inv.cuotaparte.toFixed(5),
          precioCompraBase.toFixed(5),
          parseFloat(valorInversion.toFixed(2)),
          (viewMode === 'MONTHLY' && valorCargado > 0) ? parseFloat((inv.cuotaparte * valorCargado).toFixed(2)) : '-',
          (valorActual !== '-' ? parseFloat(valorActual.toFixed(5)) : '-'), // Hasta 5 decimales
          (difValue !== '-' ? parseFloat(difValue.toFixed(2)) : '-')
        ];

        if(inv.moneda === 'PESOS'){
          portPesos.push(row);
        } else{
          portDolares.push(row);
        }
      });

      const ws_portPesos = XLSX.utils.aoa_to_sheet(portPesos);
      XLSX.utils.book_append_sheet(wb, ws_portPesos, "Portafolio Pesos");
      const ws_portDolares = XLSX.utils.aoa_to_sheet(portDolares);
      XLSX.utils.book_append_sheet(wb, ws_portDolares, "Portafolio Dólares");

      // Operaciones Cerradas
      const opPesos = [["Fecha Venta","Nombre","Moneda","Q Cuotaparte","Precio Compra","Precio Venta","Comisiones Pagadas","Valor a Reinvertir","Rendimiento"]];
      const opDolares = [["Fecha Venta","Nombre","Moneda","Q Cuotaparte","Precio Compra","Precio Venta","Comisiones Pagadas","Valor a Reinvertir","Rendimiento"]];
      operacionesCerradas.forEach(op => {
        const fila = [
          op.fecha,
          op.nombre,
          op.moneda,
          parseFloat(op.cuotaparte.toFixed(5)),
          parseFloat(op.precioCompra.toFixed(2)),
          parseFloat(op.precioVenta.toFixed(2)),
          parseFloat(op.comisiones.toFixed(2)),
          parseFloat(op.valorAReinvertir.toFixed(2)),
          parseFloat(op.rendimiento.toFixed(2))
        ];
        if(op.moneda === 'PESOS'){
          opPesos.push(fila);
        } else{
          opDolares.push(fila);
        }
      });
      const ws_opPesos = XLSX.utils.aoa_to_sheet(opPesos);
      XLSX.utils.book_append_sheet(wb, ws_opPesos, "Operaciones Cerradas Pesos");
      const ws_opDolares = XLSX.utils.aoa_to_sheet(opDolares);
      XLSX.utils.book_append_sheet(wb, ws_opDolares, "Operaciones Cerradas Dólares");

      // Valores Mensuales
      const valPesos = [["Mes/Año","Nombre Inversión","Valor Actual"]];
      const valDolares = [["Mes/Año","Nombre Inversión","Valor Actual"]];
      Object.keys(valoresMensuales).sort().forEach(mKey => {
        Object.keys(valoresMensuales[mKey].values).forEach(id => {
          const inv = inversiones.find(i => i.id == id);
          if(inv){
            const row = [mKey, inv.nombre, parseFloat(valoresMensuales[mKey].values[id].toFixed(5))];
            if(inv.moneda === 'PESOS') valPesos.push(row);
            else valDolares.push(row);
          }
        });
      });
      const ws_valPesos = XLSX.utils.aoa_to_sheet(valPesos);
      XLSX.utils.book_append_sheet(wb, ws_valPesos, "Valores Mensuales Pesos");
      const ws_valDolares = XLSX.utils.aoa_to_sheet(valDolares);
      XLSX.utils.book_append_sheet(wb, ws_valDolares, "Valores Mensuales Dólares");

      // Resumen
      if(totalesGlobal){
        const pes = totalesGlobal.PESOS;
        const dol = totalesGlobal.DOLARES;
        const difPes = pes.valorActual - pes.valorInversion;
        const difDol = dol.valorActual - dol.valorInversion;

        const resPesos = [
          ["Resumen de Inversiones en Pesos"],
          ["Categoría","Valor"],
          ["Total Inversión", parseFloat(pes.valorInversion.toFixed(2))],
          ["Total Cierre Mes", parseFloat(pes.valorCierreMes.toFixed(2))],
          ["Total Actual", parseFloat(pes.valorActual.toFixed(5))],
          ["Diferencia", parseFloat(difPes.toFixed(2))]
        ];
        const resDolares = [
          ["Resumen de Inversiones en Dólares"],
          ["Categoría","Valor"],
          ["Total Inversión", parseFloat(dol.valorInversion.toFixed(2))],
          ["Total Cierre Mes", parseFloat(dol.valorCierreMes.toFixed(2))],
          ["Total Actual", parseFloat(dol.valorActual.toFixed(5))],
          ["Diferencia", parseFloat(difDol.toFixed(2))]
        ];

        const ws_resPesos = XLSX.utils.aoa_to_sheet(resPesos);
        XLSX.utils.book_append_sheet(wb, ws_resPesos, "Resumen Pesos");
        const ws_resDolares = XLSX.utils.aoa_to_sheet(resDolares);
        XLSX.utils.book_append_sheet(wb, ws_resDolares, "Resumen Dólares");
      }

      XLSX.writeFile(wb, "Portfolio_Inversiones_Completo.xlsx");
      mostrarToast('Exportación a Excel completada.', 'success');
    }

    /**************************************************************
     * DESCARGAR PLANTILLA Y SUBIR VALORES MASIVAMENTE
     **************************************************************/
    // Funciones añadidas para descargar y subir plantillas en Valores Actuales

    function descargarTemplateValores(){
      const selectedMonth = document.getElementById('currentValuesMonth').value;
      if(!selectedMonth){
        mostrarToast('Por favor, seleccione un mes/año para descargar la plantilla.', 'warning');
        return;
      }

      const inversionesFiltradas = inversiones.filter(inv => inv.fecha.slice(0,7) <= selectedMonth);
      if(inversionesFiltradas.length === 0){
        mostrarToast('No hay inversiones cargadas para el mes/año seleccionado.', 'warning');
        return;
      }

      const data = [["Nombre de la Inversión", "Valor Actual"]];
      inversionesFiltradas.forEach(inv => {
        const valorActual = valoresMensuales[selectedMonth]?.values[inv.id] || '';
        data.push([inv.nombre, valorActual]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Template Valores");
      XLSX.writeFile(wb, `Template_Valores_${selectedMonth}.xlsx`);
      mostrarToast('Plantilla descargada exitosamente.', 'success');
    }

    function subirTemplateValores(){
      document.getElementById('uploadTemplateInput').click();
    }

    function procesarArchivoTemplateValores(event){
      const file = event.target.files[0];
      if(!file){
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e){
        const data = e.target.result;
        let workbook;
        try {
          workbook = XLSX.read(data, {type: 'binary'});
        } catch(error){
          mostrarToast('Error al leer el archivo. Asegúrate de que el formato sea correcto.', 'danger');
          return;
        }

        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header:1});

        if(jsonData.length < 2){
          mostrarToast('El archivo no contiene datos.', 'warning');
          return;
        }

        const headers = jsonData[0];
        if(headers.length < 2 ||
           headers[0] !== "Nombre de la Inversión" ||
           headers[1] !== "Valor Actual"){
          mostrarToast('La plantilla no tiene el formato correcto. Debe incluir "Nombre de la Inversión" y "Valor Actual".', 'danger');
          return;
        }

        const dataRows = jsonData.slice(1);

        const monthKey = document.getElementById('currentValuesMonth').value;
        if(!monthKey){
          mostrarToast('Selecciona un mes/año antes de subir la plantilla.', 'warning');
          return;
        }

        if(!valoresMensuales[monthKey]){
          valoresMensuales[monthKey] = {closed: false, values: {}};
        }

        let allValid = true;
        dataRows.forEach(row => {
          const [nombre, valor] = row;
          if(nombre && valor){
            const inv = inversiones.find(i => i.nombre === nombre);
            if(inv){
              const val = parseFloat(valor);
              if(!isNaN(val) && val > 0){
                valoresMensuales[monthKey].values[inv.id] = parseFloat(val.toFixed(5)); // Hasta 5 decimales
                inv.valorActual = val;
              } else {
                allValid = false;
              }
            }
          }
        });

        if(allValid){
          actualizarTabla();
          mostrarToast('Valores actualizados correctamente desde la plantilla.', 'success');
          guardarDatos();
        } else{
          mostrarToast('Algunos valores son inválidos. Revisa la plantilla.', 'danger');
        }
        document.getElementById('uploadTemplateInput').value = '';
      };
      reader.onerror = function(){
        mostrarToast('Error al leer el archivo.', 'danger');
      };
      reader.readAsBinaryString(file);
    }

    /**************************************************************
     * RESULTADOS MENSUALES / HISTÓRICOS (MODALES)
     **************************************************************/
    function mostrarResultadosMensuales(){
      const modalId = 'monthlyResultsModal';
      const modal = document.getElementById(modalId);
      const content = document.getElementById('monthlyResultsContent');

      if(!modal){
        mostrarToast('El modal de Resultados Mensuales no está definido en HTML.', 'danger');
        return;
      }

      const selectedMonth = document.getElementById('monthYear').value;

      if(!selectedMonth){
        mostrarToast('Seleccione un mes/año en los filtros de arriba.', 'warning');
        return;
      }
      if(!valoresMensuales[selectedMonth]?.closed){
        mostrarToast('El mes seleccionado no está cerrado. Cierre el mes antes de ver rendimiento mensual.', 'warning');
        return;
      }

      const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) <= selectedMonth);
      if(invMes.length === 0){
        content.innerHTML = '<p>No hay inversiones vigentes hasta el mes seleccionado.</p>';
      } else{
        content.innerHTML = ''; // Limpiar contenido previo
        invMes.forEach(inv => {
          let precioCompra;
          if(inv.fecha.slice(0,7) === selectedMonth){
            precioCompra = valoresMensuales[selectedMonth]?.values[inv.id] || inv.precio;
          } else{
            const prevMonth = getPreviousMonth(selectedMonth);
            precioCompra = valoresMensuales[prevMonth]?.values[inv.id] || inv.precio;
          }

          const valorInversion = inv.cuotaparte * precioCompra;
          const valorActual = valoresMensuales[selectedMonth].values[inv.id] ? inv.cuotaparte * valoresMensuales[selectedMonth].values[inv.id] : 0;
          const diferencia = valorActual - valorInversion;
          const porcentaje = calculatePercentage(valorActual, valorInversion);

          const dias = calcularDiasDesdeHoy(inv.fecha);

          content.innerHTML += `
            <div class="summary-section">
              <h4>${escapeHTML(inv.nombre)} (${escapeHTML(inv.moneda)}) 
                  - Adquirido: ${inv.fecha} (hace ${dias} días)</h4>
              <div class="summary-item">
                <span class="summary-label">Total Inversión:</span>
                <span class="summary-value">${formatCurrency(valorInversion, inv.moneda, 2)}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Valor Actual:</span>
                <span class="summary-value">${formatCurrency(valorActual, inv.moneda, 5)}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Rendimiento:</span>
                <span class="summary-value" style="color:${diferencia >= 0 ? successColor : dangerColor};">
                  ${
                    (diferencia !== 0)
                      ? formatCurrency(Math.abs(diferencia), inv.moneda, 2) +
                        (diferencia >= 0 ? ' (Ganancia)' : ' (Pérdida)') +
                        (porcentaje ? ` (${Math.abs(porcentaje)}%)` : '') +
                        (diferencia >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false))
                      : '-'
                  }
                </span>
              </div>
            </div>
          `;
        });
      }
      modal.classList.add('visible');
      closeNav();
    }
    function cerrarResultadosMensuales(){
      const modalId = 'monthlyResultsModal';
      const modal = document.getElementById(modalId);
      if(modal){
        modal.classList.remove('visible');
      }
    }

    function mostrarResultadosHistoricos(){
      const modal = document.getElementById('historicalResultsModal');
      const content = document.getElementById('historicalResultsContent');
      content.innerHTML = '';
      const selectedMonth = document.getElementById('monthYear').value;

      if(!selectedMonth){
        mostrarToast('Seleccione un mes/año en los filtros de arriba.', 'warning');
        return;
      }
      if(!valoresMensuales[selectedMonth]?.closed){
        mostrarToast('El mes seleccionado no está cerrado. Cierre el mes antes de ver rendimiento histórico.', 'warning');
        return;
      }

      const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) <= selectedMonth);
      if(invMes.length === 0){
        content.innerHTML = '<p>No hay inversiones vigentes hasta el mes seleccionado.</p>';
      } else{
        invMes.forEach(inv => {
          let precioCompra = getPrecioCompraHistorico(inv, selectedMonth);
          const valorInversion = inv.cuotaparte * inv.precio;
          const valorActual = inv.valorActual ? inv.cuotaparte * inv.valorActual : 0;
          const diferencia = valorActual - valorInversion;
          const porcentaje = calculatePercentage(valorActual, valorInversion);

          const dias = calcularDiasDesdeHoy(inv.fecha);

          content.innerHTML += `
            <div class="summary-section">
              <h4>${escapeHTML(inv.nombre)} (${escapeHTML(inv.moneda)}) 
                  - Adquirido: ${inv.fecha} (hace ${dias} días)</h4>
              <div class="summary-item">
                <span class="summary-label">Total Inversión:</span>
                <span class="summary-value">${formatCurrency(valorInversion, inv.moneda, 2)}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Valor Actual:</span>
                <span class="summary-value">${formatCurrency(valorActual, inv.moneda, 5)}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Rendimiento:</span>
                <span class="summary-value" style="color:${diferencia >= 0 ? successColor : dangerColor};">
                  ${
                    (diferencia !== 0)
                      ? formatCurrency(Math.abs(diferencia), inv.moneda, 2) +
                        (diferencia >= 0 ? ' (Ganancia)' : ' (Pérdida)') +
                        (porcentaje ? ` (${Math.abs(porcentaje)}%)` : '') +
                        (diferencia >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false))
                      : '-'
                  }
                </span>
              </div>
            </div>
          `;
        });
      }
      modal.classList.add('visible');
      closeNav();
    }
    function cerrarResultadosHistoricos(){
      const modal = document.getElementById('historicalResultsModal');
      if(modal){
        modal.classList.remove('visible');
      }
    }

    /**************************************************************
     * COMISIONES PAGADAS (MODAL)
     **************************************************************/
    function mostrarComisionesPagadas(){
      const modal = document.getElementById('comisionesPagadasModal');
      const content = document.getElementById('comisionesPagadasContent');

      if(!modal){
        mostrarToast('El modal de Comisiones Pagadas no está definido en HTML.', 'danger');
        return;
      }

      if(operacionesCerradas.length === 0){
        content.innerHTML = '<p>No hay comisiones pagadas registradas.</p>';
      } else{
        // Separar comisiones de compra y venta
        const comisionesCompra = inversiones.map(inv => ({
          fecha: inv.fecha,
          nombre: inv.nombre,
          moneda: inv.moneda,
          comisiones: inv.comisionesPagadas
        })).filter(c => c.comisiones > 0);

        const comisionesVenta = operacionesCerradas.map(op => ({
          fecha: op.fecha,
          nombre: op.nombre,
          moneda: op.moneda,
          comisiones: op.comisiones
        })).filter(c => c.comisiones > 0);

        const totalCompra = comisionesCompra.reduce((acc, curr) => acc + curr.comisiones, 0);
        const totalVenta = comisionesVenta.reduce((acc, curr) => acc + curr.comisiones, 0);
        const total = totalCompra + totalVenta;

        content.innerHTML = '<h4>Comisiones de Compra</h4>';
        if(comisionesCompra.length === 0){
          content.innerHTML += '<p>No hay comisiones de compra registradas.</p>';
        } else{
          content.innerHTML += '<table><thead><tr><th>Fecha</th><th>Nombre</th><th>Moneda</th><th>Comisiones Pagadas</th></tr></thead><tbody>';
          comisionesCompra.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHTML(c.fecha)}</td>
              <td>${escapeHTML(c.nombre)}</td>
              <td>${escapeHTML(c.moneda)}</td>
              <td class="number-cell">${formatCurrency(c.comisiones, c.moneda, 2)}</td>
            `;
            content.querySelector('tbody').appendChild(tr);
          });
          content.innerHTML += '</tbody></table>';
          content.innerHTML += `<p><strong>Total Comisiones de Compra: ${formatCurrency(totalCompra, comisionesCompra[0].moneda, 2)}</strong></p>`;
        }

        content.innerHTML += '<h4>Comisiones de Venta</h4>';
        if(comisionesVenta.length === 0){
          content.innerHTML += '<p>No hay comisiones de venta registradas.</p>';
        } else{
          content.innerHTML += '<table><thead><tr><th>Fecha</th><th>Nombre</th><th>Moneda</th><th>Comisiones Pagadas</th></tr></thead><tbody>';
          comisionesVenta.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHTML(c.fecha)}</td>
              <td>${escapeHTML(c.nombre)}</td>
              <td>${escapeHTML(c.moneda)}</td>
              <td class="number-cell">${formatCurrency(c.comisiones, c.moneda, 2)}</td>
            `;
            content.querySelector('tbody').appendChild(tr);
          });
          content.innerHTML += '</tbody></table>';
          content.innerHTML += `<p><strong>Total Comisiones de Venta: ${formatCurrency(totalVenta, comisionesVenta[0].moneda, 2)}</strong></p>`;
        }

        content.innerHTML += `<h4>Total Comisiones Pagadas: ${formatCurrency(total, comisionesCompra.length > 0 ? comisionesCompra[0].moneda : comisionesVenta.length > 0 ? comisionesVenta[0].moneda : 'PESOS', 2)}</h4>`;
      }

      modal.classList.add('visible');
      closeNav();
    }
    function cerrarComisionesPagadas(){
      const modal = document.getElementById('comisionesPagadasModal');
      if(modal){
        modal.classList.remove('visible');
      }
    }

    /**************************************************************
     * VENTAS / OPERACIONES CERRADAS
     **************************************************************/
    function venderInversionPorID(id, event){
      if(event) event.preventDefault();

      const inv = inversiones.find(inv => inv.id == id);
      if(!inv){
        mostrarToast('Inversión no encontrada.', 'danger');
        return;
      }
      document.getElementById('saleId').value = inv.id;
      document.getElementById('nombreVenta').value = inv.nombre;
      document.getElementById('cuotaparteVenta').value = inv.cuotaparte;
      document.getElementById('cuotaparteVenta').readOnly = true;
      document.getElementById('tipoVenta').value = 'TOTAL';
      document.getElementById('precioVenta').value = '';
      document.getElementById('fechaVenta').value = new Date().toISOString().split('T')[0];
      document.getElementById('comisionesPagadasVenta').value = '';
      document.getElementById('saleForm').classList.add('visible');
      window.scrollTo(0, 0);
    }
    function toggleCuotaparteVenta(){
      const tipoVenta = document.getElementById('tipoVenta').value;
      const id = document.getElementById('saleId').value;
      const inv = inversiones.find(inv => inv.id == id);
      const cuotaparteInput = document.getElementById('cuotaparteVenta');
      if(inv){
        if(tipoVenta === 'TOTAL'){
          cuotaparteInput.value = inv.cuotaparte;
          cuotaparteInput.readOnly = true;
          cuotaparteInput.style.backgroundColor = '#f5f5f5';
        } else{
          cuotaparteInput.value = '';
          cuotaparteInput.readOnly = false;
          cuotaparteInput.style.backgroundColor = '';
        }
      }
    }
    function procesarVenta(e){
      e.preventDefault();

      const id = document.getElementById('saleId').value;
      const inv = inversiones.find(inv => inv.id == id);
      const cuotaparteVenta = parseFloat(document.getElementById('cuotaparteVenta').value);
      const precioVenta = parseFloat(document.getElementById('precioVenta').value);
      const fechaVenta = document.getElementById('fechaVenta').value;
      const comisiones = parseFloat(document.getElementById('comisionesPagadasVenta').value) || 0;

      if(isNaN(cuotaparteVenta) || isNaN(precioVenta)){
        mostrarToast('Valores inválidos en cuotaparte o precio de venta.', 'warning');
        return;
      }
      if(cuotaparteVenta <= 0 || precioVenta <= 0){
        mostrarToast('Q Cuotaparte y Precio de Venta deben ser números positivos.', 'warning');
        return;
      }
      if(!fechaVenta){
        mostrarToast('Seleccione una fecha de venta.', 'warning');
        return;
      }
      if(cuotaparteVenta > inv.cuotaparte){
        mostrarToast('No puedes vender más cuotapartes de las que posees.', 'warning');
        return;
      }

      const valorVentaTotal = precioVenta * cuotaparteVenta;
      const valorAReinvertir = valorVentaTotal - comisiones;
      const valorCompraTotal = inv.precio * cuotaparteVenta;
      const resultado = valorAReinvertir - valorCompraTotal;

      const opCerrada = {
        id: inv.id, // Asociar operación con el ID de la inversión
        fecha: fechaVenta,
        nombre: inv.nombre,
        moneda: inv.moneda,
        cuotaparte: cuotaparteVenta,
        precioCompra: inv.precio,
        precioVenta,
        comisiones,
        valorAReinvertir: isNaN(valorAReinvertir) ? 0 : parseFloat(valorAReinvertir.toFixed(2)),
        rendimiento: isNaN(resultado) ? 0 : parseFloat(resultado.toFixed(2))
      };
      operacionesCerradas.push(opCerrada);

      if(document.getElementById('tipoVenta').value === 'PARCIAL'){
        inv.cuotaparte -= cuotaparteVenta;
      } else{
        const nombreEliminado = inv.nombre;
        inversiones = inversiones.filter(i => i.id != inv.id);

        // Eliminar operaciones cerradas relacionadas (con ese mismo id)
        operacionesCerradas = operacionesCerradas.filter(op => op.id != inv.id);

        // Eliminar valores mensuales relacionados
        Object.keys(valoresMensuales).forEach(month => {
          if(valoresMensuales[month].values[inv.id]){
            delete valoresMensuales[month].values[inv.id];
          }
        });
      }
      actualizarTabla();
      cancelarVenta();
      mostrarOperacionesCerradas();
      mostrarToast('Venta procesada exitosamente.', 'success');
      guardarDatos();
    }
    function cancelarVenta(){
      document.getElementById('saleForm').classList.remove('visible');
      document.getElementById('ventaForm').reset();
      document.getElementById('saleId').value = -1;
    }

    function mostrarOperacionesCerradas(){
      const modal = document.getElementById('closedOperationsModal');
      const tbody = document.getElementById('closedOperationsBody');
      tbody.innerHTML = '';

      let totales = {PESOS: 0, DOLARES: 0};
      operacionesCerradas.forEach(op => {
        totales[op.moneda] += op.rendimiento;
        const pct = calculatePercentage(op.rendimiento, (op.cuotaparte * op.precioCompra));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="selectClosedOp" value="${op.id}"></td>
          <td>${escapeHTML(op.fecha)}</td>
          <td>${escapeHTML(op.nombre)}</td>
          <td>${escapeHTML(op.moneda)}</td>
          <td class="number-cell">${formatNumber(op.cuotaparte, 5)}</td>
          <td class="number-cell">${formatNumber(op.precioCompra, 5)}</td>
          <td class="number-cell">${formatNumber(op.precioVenta, 5)}</td>
          <td class="number-cell">${formatCurrency(op.comisiones, op.moneda, 2)}</td>
          <td class="number-cell">${formatCurrency(op.valorAReinvertir, op.moneda, 2)}</td>
          <td class="number-cell" style="color:${op.rendimiento >= 0 ? successColor : dangerColor}; font-weight:bold;">
            ${formatCurrency(op.rendimiento, op.moneda, 2)}
            ${pct ? ` (${Math.abs(pct)}%)` : ''}
            ${op.rendimiento >= 0 ? '<i class="fa-solid fa-arrow-up"></i>' : '<i class="fa-solid fa-arrow-down"></i>'}
          </td>
        `;
        tbody.appendChild(tr);
      });

      Object.keys(totales).forEach(mon => {
        const labelMon = (mon === 'PESOS') ? 'Pesos' : 'Dólares';
        const trTotal = document.createElement('tr');
        trTotal.innerHTML = `
          <td colspan="8" style="text-align:right; font-weight:bold;">
            Total Resultado en ${labelMon}:
          </td>
          <td class="number-cell" style="color:${totales[mon] >= 0 ? successColor : dangerColor}; font-weight:bold;">
            ${formatCurrency(totales[mon], mon, 2)} (${totales[mon] >= 0 ? 'Ganancia' : 'Pérdida'})
          </td>
        `;
        tbody.appendChild(trTotal);
      });

      modal.classList.add('visible');
      closeNav();
    }

    function cerrarModalOperaciones(){
      const modal = document.getElementById('closedOperationsModal');
      if(modal){
        modal.classList.remove('visible');
      }
    }

    function seleccionarTodasOperaciones(checked){
      const checkboxes = document.querySelectorAll('.selectClosedOp');
      checkboxes.forEach(cb => cb.checked = checked);
    }

    function borrarOperacionesCerradas(){
      const checkboxes = document.querySelectorAll('.selectClosedOp:checked');
      if(checkboxes.length === 0){
        mostrarToast('No has seleccionado ninguna operación para eliminar.', 'warning');
        return;
      }
      if(confirm(`¿Estás seguro de eliminar ${checkboxes.length} operación(es) seleccionada(s)?`)){
        const idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
        operacionesCerradas = operacionesCerradas.filter(op => !idsToDelete.includes(op.id));
        actualizarTabla();
        mostrarOperacionesCerradas();
        mostrarToast('Operaciones eliminadas exitosamente.', 'success');
        guardarDatos();
      }
    }

    /**************************************************************
     * GRÁFICO RENDIMIENTO (Con toggle: Mensual / Histórico)
     **************************************************************/
    function abrirModalRendimiento(){
      const toggle = document.getElementById('toggleChartMode');
      const lbl = document.getElementById('toggleChartLabel');
      lbl.textContent = toggle.checked ? 'Mensual' : 'Histórico';

      document.getElementById('rendimientoModal').classList.add('visible');
      generarGraficoRendimiento();
      closeNav();
    }
    function cerrarGraficoRendimiento(){
      document.getElementById('rendimientoModal').classList.remove('visible');
      if(doughnutPesos) doughnutPesos.destroy();
      if(doughnutDolares) doughnutDolares.destroy();
      document.getElementById('legendPesos').innerHTML = '';
      document.getElementById('legendDolares').innerHTML = '';
    }

    function generarGraficoRendimiento(){
      const inputMonth = document.getElementById('monthYearRendimiento').value;
      const toggleChart = document.getElementById('toggleChartMode');
      const lbl = document.getElementById('toggleChartLabel');

      lbl.textContent = toggleChart.checked ? 'Mensual' : 'Histórico';

      if(!inputMonth){
        if(doughnutPesos) doughnutPesos.destroy();
        if(doughnutDolares) doughnutDolares.destroy();
        document.getElementById('legendPesos').innerHTML = '';
        document.getElementById('legendDolares').innerHTML = '';
        return;
      }

      const isMonthly = toggleChart.checked;
      const listaFiltrada = inversiones.filter(inv => inv.fecha.slice(0,7) <= inputMonth);
      if(listaFiltrada.length === 0){
        if(doughnutPesos) doughnutPesos.destroy();
        if(doughnutDolares) doughnutDolares.destroy();
        document.getElementById('legendPesos').innerHTML = '';
        document.getElementById('legendDolares').innerHTML = '';
        return;
      }

      function calcPrecioMensual(inv){
        const invMonth = inv.fecha.slice(0,7);
        if(invMonth === inputMonth){
          return valoresMensuales[inputMonth]?.values[inv.id] || inv.precio;
        } else{
          const prevMonth = getPreviousMonth(inputMonth);
          const valAnterior = valoresMensuales[prevMonth]?.values[inv.id];
          return (valAnterior && valAnterior > 0) ? valAnterior : inv.precio;
        }
      }
      function calcPrecioHistorico(inv){
        return inv.precio;
      }

      let distPesos = {};
      let distDolares = {};

      const tiposVigentes = [...new Set(listaFiltrada.map(i => i.tipo))];
      tiposVigentes.forEach(t => {
        distPesos[t] = 0;
        distDolares[t] = 0;
      });

      listaFiltrada.forEach(inv => {
        let precioBase = isMonthly ? calcPrecioMensual(inv) : calcPrecioHistorico(inv);
        let valorCargado = 0;
        let valorInversion = inv.cuotaparte * inv.precio;
        let valorActual = 0;

        if(isMonthly && valoresMensuales[inputMonth]?.closed){
          valorCargado = valoresMensuales[inputMonth].values[inv.id] || 0;
        }

        if(isMonthly && valorCargado > 0){
          valorActual = inv.cuotaparte * valorCargado;
        } else if(!isMonthly && valoresMensuales[inputMonth]?.closed){
          valorActual = inv.cuotaparte * precioBase;
        } else{
          valorActual = inv.valorActual && inv.valorActual > 0
            ? inv.cuotaparte * inv.valorActual
            : inv.cuotaparte * inv.precio;
        }

        if(inv.moneda === 'PESOS'){
          distPesos[inv.tipo] += valorActual > 0 ? valorActual : valorInversion;
        } else{
          distDolares[inv.tipo] += valorActual > 0 ? valorActual : valorInversion;
        }
      });

      const labelsPesos = [];
      const dataPesos = [];
      Object.keys(distPesos).forEach(tipo => {
        if(distPesos[tipo] > 0){
          labelsPesos.push(tipo);
          dataPesos.push(parseFloat(distPesos[tipo].toFixed(2)));
        }
      });
      const labelsDolares = [];
      const dataDolares = [];
      Object.keys(distDolares).forEach(tipo => {
        if(distDolares[tipo] > 0){
          labelsDolares.push(tipo);
          dataDolares.push(parseFloat(distDolares[tipo].toFixed(2)));
        }
      });

      const chartColors = [
        '#3498db','#e67e22','#9b59b6','#f1c40f',
        '#1abc9c','#2ecc71','#34495e','#c0392b'
      ];

      if(doughnutPesos) doughnutPesos.destroy();
      if(doughnutDolares) doughnutDolares.destroy();

      const ctxPesos = document.getElementById('chartPesos').getContext('2d');
      const ctxDolares = document.getElementById('chartDolares').getContext('2d');

      doughnutPesos = new Chart(ctxPesos, {
        type: 'doughnut',
        data: {
          labels: labelsPesos,
          datasets: [{
            data: dataPesos,
            backgroundColor: chartColors.slice(0, labelsPesos.length)
          }]
        },
        options: {
          responsive: true,
          cutout: '60%',
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: 'end',
              align: 'start', // Ajustado para evitar superposición
              offset: 10,
              color: '#444',
              font: { weight: 'bold' },
              formatter: function(value, context){
                let total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                if(value > 0){
                  let pct = (value * 100 / total).toFixed(1) + '%';
                  return pct + ' ' + context.chart.data.labels[context.dataIndex];
                }
                return '';
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      doughnutDolares = new Chart(ctxDolares, {
        type: 'doughnut',
        data: {
          labels: labelsDolares,
          datasets: [{
            data: dataDolares,
            backgroundColor: chartColors.slice(labelsPesos.length, labelsPesos.length + labelsDolares.length)
          }]
        },
        options: {
          responsive: true,
          cutout: '60%',
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: 'end',
              align: 'start', // Ajustado para evitar superposición
              offset: 10,
              color: '#444',
              font: { weight: 'bold' },
              formatter: function(value, context){
                let total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                if(value > 0){
                  let pct = (value * 100 / total).toFixed(1) + '%';
                  return pct + ' ' + context.chart.data.labels[context.dataIndex];
                }
                return '';
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      generarLeyenda('legendPesos', labelsPesos, chartColors.slice(0, labelsPesos.length), dataPesos);
      generarLeyenda('legendDolares', labelsDolares, chartColors.slice(labelsPesos.length, labelsPesos.length + labelsDolares.length), dataDolares);
    }

    function generarLeyenda(elementId, labels, colors, data){
      const legendContainer = document.getElementById(elementId);
      legendContainer.innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">';
      labels.forEach((label, index) => {
        const percentage = ((data[index] / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1) + '%';
        legendContainer.innerHTML += `
          <li style="display: flex; align-items: center; margin-bottom: 0.5rem;">
            <span class="color-box" style="background-color:${colors[index]}; width:15px; height:15px; display:inline-block; margin-right:0.5rem; border-radius:3px;"></span>
            <span class="label">${label}</span>
            <span class="percentage" style="margin-left:auto; font-weight:bold;">${percentage}</span>
          </li>
        `;
      });
      legendContainer.innerHTML += '</ul>';
    }

    /**************************************************************
     * FUNCIONALIDADES ADICIONALES: Descargar y Subir localStorage
     **************************************************************/
    function descargarLocalStorage(){
      const dataToExport = {
        inversiones,
        operacionesCerradas,
        valoresMensuales,
        configOrigen,
        configTipo,
        configMoneda,
        nextInvestmentId
      };

      const ws_data = [["Inversiones", "Operaciones Cerradas", "Valores Mensuales", "ConfigOrigen", "ConfigTipo", "ConfigMoneda", "NextInvestmentId"]];

      ws_data.push([
        JSON.stringify(dataToExport.inversiones),
        JSON.stringify(dataToExport.operacionesCerradas),
        JSON.stringify(dataToExport.valoresMensuales),
        JSON.stringify(dataToExport.configOrigen),
        JSON.stringify(dataToExport.configTipo),
        JSON.stringify(dataToExport.configMoneda),
        JSON.stringify(dataToExport.nextInvestmentId)
      ]);

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "localStorage");
      XLSX.writeFile(wb, "Portfolio_LocalStorage_Data.xlsx");

      mostrarToast('Descarga completada correctamente.', 'success');
    }

    function subirLocalStorage(){
      document.getElementById('uploadLocalStorageInput').click();
    }

    function procesarArchivoLocalStorage(event){
      const file = event.target.files[0];
      if(!file){
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e){
        const data = e.target.result;
        let workbook;
        try {
          workbook = XLSX.read(data, {type: 'binary'});
        } catch(error){
          mostrarToast('Error al leer el archivo. Asegúrate de que el formato sea correcto.', 'danger');
          return;
        }

        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header:1});

        if(jsonData.length < 2){
          mostrarToast('El archivo no contiene datos.', 'warning');
          return;
        }

        const headers = jsonData[0];
        if(headers.length < 7 ||
           headers[0] !== "Inversiones" ||
           headers[1] !== "Operaciones Cerradas" ||
           headers[2] !== "Valores Mensuales" ||
           headers[3] !== "ConfigOrigen" ||
           headers[4] !== "ConfigTipo" ||
           headers[5] !== "ConfigMoneda" ||
           headers[6] !== "NextInvestmentId"){
          mostrarToast('La plantilla no tiene el formato correcto. Debe incluir "Inversiones", "Operaciones Cerradas", "Valores Mensuales", "ConfigOrigen", "ConfigTipo", "ConfigMoneda", "NextInvestmentId".', 'danger');
          return;
        }

        const dataRow = jsonData[1];
        if(dataRow.length < 7){
          mostrarToast('La plantilla no tiene suficientes datos.', 'danger');
          return;
        }

        try {
          let nuevasInversiones = JSON.parse(dataRow[0]);
          // Asignar ID a inversiones sin uno
          nuevasInversiones.forEach(inv => {
            if(!inv.id){
              inv.id = nextInvestmentId++;
            }
          });
          inversiones = nuevasInversiones;

          operacionesCerradas = JSON.parse(dataRow[1]);
          valoresMensuales = JSON.parse(dataRow[2]);
          configOrigen = JSON.parse(dataRow[3]);
          configTipo = JSON.parse(dataRow[4]);
          configMoneda = JSON.parse(dataRow[5]);
          nextInvestmentId = JSON.parse(dataRow[6]);

          guardarDatos();

          actualizarSelects();
          actualizarConfigModal();
          actualizarTabla();

          cerrarConfiguracion();
          mostrarToast('Subida completada correctamente.', 'success');
          document.getElementById('uploadLocalStorageInput').value = '';
        } catch(error){
          mostrarToast('Error al procesar los datos del archivo.', 'danger');
        }
      };
      reader.onerror = function(){
        mostrarToast('Error al leer el archivo.', 'danger');
      };
      reader.readAsBinaryString(file);
    }

    /**************************************************************
     * NOTIFICACIONES TOAST
     **************************************************************/
    function mostrarToast(mensaje, tipo='success'){
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast' + Date.now();
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${tipo} border-0`;
      toast.role = 'alert';
      toast.ariaLive = 'assertive';
      toast.ariaAtomic = 'true';
      toast.id = toastId;
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${mensaje}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(document.getElementById(toastId), { delay: 3000 });
      bsToast.show();
    }

    /**************************************************************
     * INICIALIZAR
     **************************************************************/
    function inicializarDatos(){
      // No cargar inversiones de ejemplo
      // Iniciar con configuraciones por defecto si están vacías
      if(configOrigen.length === 0){
        configOrigen = ["LOCAL","EXTRANJERO"];
      }
      if(configTipo.length === 0){
        configTipo = ["ACCIONES","BONOS","FONDOS MUTUOS","CRIPTO"];
      }
      if(configMoneda.length === 0){
        configMoneda = ["PESOS","DOLARES"];
      }
      guardarDatos();
    }
    function inicializarApp(){
      cargarDatos();
      inicializarDatos();
      actualizarSelects();
      actualizarConfigModal();
      actualizarTabla();
    }

    window.onload = inicializarApp;
  </script>
</body>
</html>
