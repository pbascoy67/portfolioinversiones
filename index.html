<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portfolio de Inversiones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Font Awesome (para íconos) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Data Labels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Variables CSS */
    :root {
      --primary: #2c3e50;
      --secondary: #34495e;
      --accent: #1e3799; /* Azul oscuro para bordes */
      --success: #27ae60;
      --danger: #c0392b;
      --background: #ecf0f1;
      --text: #2c3e50;
      --readonly-bg: #f5f5f5;
      --button-export: #8e44ad;
      --button-chart: #16a085;
      --summary-bg: #1e3799; /* Azul oscuro */
      --btn-edit-color: #f1c40f;
      --btn-edit-hover: #f39c12;
      --button-size: 1.1rem 1.5rem;
      --small-button-size: 0.8rem 1rem;
      --transition-speed: 0.3s;
    }

    /* Modo Oscuro */
    body.dark-mode {
      --primary: #34495e;
      --secondary: #2c3e50;
      --accent: #1e3799; /* Azul oscuro para bordes */
      --success: #27ae60;
      --danger: #c0392b;
      --background: #2c3e50;
      --text: #ecf0f1;
      --readonly-bg: #3d566e;
      --button-export: #8e44ad;
      --button-chart: #16a085;
      --summary-bg: #1e3799; /* Azul oscuro */
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background);
      color: var(--text);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    header, footer {
      background-color: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
      position: relative;
    }

    main {
      padding: 1rem;
      transition: margin-left var(--transition-speed);
    }

    /* Menú Lateral */
    .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 2000; /* Asegura que esté por encima de otros elementos */
      top: 0;
      left: 0;
      background-color: var(--secondary);
      overflow-x: hidden;
      transition: width var(--transition-speed);
      padding-top: 60px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }

    .sidenav a {
      padding: 10px 20px;
      text-decoration: none;
      font-size: 1.1rem;
      color: white;
      display: block;
      transition: background-color var(--transition-speed);
    }

    .sidenav a:hover {
      background-color: var(--primary);
    }

    .sidenav .closebtn {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    /* Botón de Configuración */
    .open-sidenav-btn {
      font-size: 1.5rem;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
      position: fixed; /* Cambiado de absolute a fixed */
      top: 10px;
      left: 20px;
      z-index: 2100; /* Por encima del menú lateral */
    }

    /* Botón Modo Oscuro */
    .toggle-dark-mode {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--secondary);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color var(--transition-speed);
      z-index: 1000;
    }

    .toggle-dark-mode:hover {
      background-color: var(--primary);
    }

    /* Secciones */
    .filters, .actions, .summary, .tables, .modals {
      margin-bottom: 1.5rem;
    }

    /* Ajustes de la Sección de Filtros */
    .filters {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      overflow-x: auto;
      background-color: var(--secondary);
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .filters label {
      flex: 0 0 150px; /* Ancho fijo para las etiquetas */
      font-weight: bold;
      color: white;
    }

    .filters select, 
    .filters input[type="month"] {
      flex: 1 1 auto;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border-color var(--transition-speed);
      background-color: white;
      color: var(--text);
      min-width: 150px;
    }

    .filters select:focus, .filters input[type="month"]:focus {
      border-color: var(--accent);
      outline: none;
    }

    @media (max-width: 800px) {
      .filters {
        flex-wrap: wrap;
        justify-content: center;
      }

      .filters label {
        flex: 0 0 100%;
        text-align: center;
        color: white;
      }

      .filters select, 
      .filters input[type="month"] {
        flex: 0 0 100%;
        max-width: 100%;
        background-color: #ecf0f1;
      }
    }

    /* Centrando botones */
    .actions > div {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .actions-top button, .actions-middle button, .actions-bottom button {
      padding: var(--button-size);
      margin: 0.3rem;
      border: none;
      border-radius: 5px;
      background-color: var(--secondary);
      color: white;
      cursor: pointer;
      transition: background-color var(--transition-speed), transform var(--transition-speed);
      font-size: 1rem;
      min-width: 150px; /* Ajuste de ancho mínimo */
    }

    .actions-top button:hover, .actions-middle button:hover, .actions-bottom button:hover {
      background-color: var(--primary);
      transform: scale(1.05);
    }

    .actions-bottom .export-button, .actions-bottom .chart-button {
      background-color: var(--button-export);
      min-width: 200px; /* Más ancho para botones especiales */
    }

    .actions-bottom .chart-button {
      background-color: var(--button-chart);
    }

    .actions-bottom .export-button:hover {
      background-color: #7d3c98;
    }

    .actions-bottom .chart-button:hover {
      background-color: #148f77;
    }

    /* Resumen */
    .summary {
      display: flex;
      justify-content: space-between;
      background-color: var(--summary-bg);
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .summary-box {
      width: 48%;
      background-color: white;
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border: 2px solid var(--accent); /* Azul oscuro */
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode .summary-box {
      background-color: #34495e;
      color: #ecf0f1;
    }

    .summary-box h4 {
      text-align: center;
      margin-bottom: 1rem;
      color: var(--primary);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.5rem;
    }

    /* Ajuste para modo oscuro: títulos en blanco */
    body.dark-mode .summary-box h4 {
      color: white;
    }

    .summary-item {
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .summary-label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    .summary-value {
      font-size: 1.2rem;
    }

    /* Tablas */
    .tables table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode .tables table {
      background-color: #34495e;
      color: #ecf0f1;
    }

    .tables th, .tables td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: left;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    .tables th {
      background-color: var(--secondary);
      color: white;
    }

    body.dark-mode .tables th {
      background-color: var(--primary);
      color: #ecf0f1;
    }

    .tables tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    body.dark-mode .tables tr:nth-child(even) {
      background-color: #3d566e;
    }

    .number-cell {
      text-align: right;
      min-width: 100px; /* Ajuste de ancho mínimo */
    }

    /* Acciones con Hover */
    .acciones {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      opacity: 0;
      transition: opacity var(--transition-speed);
    }

    /* Mostrar acciones al hacer hover en la fila */
    .tables tr:hover .acciones {
      opacity: 1;
    }

    .acciones .btn-group {
      display: flex;
      gap: 0.3rem;
    }

    .acciones button {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color var(--transition-speed);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .acciones button:hover {
      opacity: 0.8;
    }

    .btn-edit {
      background-color: var(--btn-edit-color);
      color: black;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-edit:hover {
      background-color: var(--btn-edit-hover);
    }

    .btn-sell {
      background-color: var(--success);
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-delete {
      background-color: var(--danger);
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      margin-top: 0.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000; /* Por encima del menú lateral */
    }

    .modal.visible {
      display: flex;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 5px;
      width: 90%;
      max-width: 800px;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode .modal-content {
      background-color: #34495e;
      color: #ecf0f1;
    }

    .modal-content h3, .modal-content h4 {
      margin-top: 0;
    }

    .close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--danger);
    }

    /* Forms */
    .form-section {
      display: none;
      background-color: white;
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    body.dark-mode .form-section {
      background-color: #34495e;
      color: #ecf0f1;
    }

    .form-section.visible {
      display: block;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      gap: 1rem;
    }

    .form-group {
      flex: 1;
      min-width: 300px; /* Aumentado para ocupar más espacio */
      margin-right: 1rem;
      margin-bottom: 0.5rem;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      display: inline-block;
      width: 200px; /* Ancho ajustado para acomodar números de 6 enteros y 2 decimales */
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    .form-group input, .form-group select {
      width: calc(100% - 200px);
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 3px;
      transition: border-color var(--transition-speed), background-color var(--transition-speed), color var(--transition-speed);
      background-color: var(--background);
      color: var(--text);
      min-width: 15ch; /* Mínimo de 15 caracteres */
    }

    body.dark-mode .form-group input, 
    body.dark-mode .form-group select {
      background-color: #3d566e;
      color: #ecf0f1;
      border: 1px solid #555;
    }

    .form-group input:focus, .form-group select:focus {
      border-color: var(--accent);
      outline: none;
    }

    .form-actions {
      text-align: right;
    }

    .form-actions button {
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: var(--primary);
      color: white;
      transition: background-color var(--transition-speed), transform var(--transition-speed);
      font-size: 1rem;
      min-width: 150px; /* Asegurar un ancho consistente */
    }

    .form-actions button:hover {
      background-color: var(--secondary);
      transform: scale(1.05);
    }

    .cancel-button {
      background-color: var(--danger);
    }

    .cancel-button:hover {
      background-color: #a93226;
    }

    .form-group.comisiones-pagadas {
      max-width: 25ch; /* Limita el ancho a 25 caracteres */
    }

    .form-group.comisiones-pagadas input {
      width: 100%; /* Ocupa todo el ancho del contenedor limitado */
    }

    /* Responsive */
    @media (max-width: 600px) {
      .summary {
        flex-direction: column;
        align-items: center;
      }
      .summary-box {
        width: 100%;
      }
      .form-row {
        flex-direction: column;
      }
      .form-group {
        margin-right: 0;
        min-width: 100%;
      }
      .rendimiento-charts-container {
        flex-direction: column;
        align-items: center;
      }
      .actions-top, .actions-middle, .actions-bottom, .actions-extra {
        flex-direction: column;
      }
    }

    /* Gráficos de Rendimiento */
    .rendimiento-charts-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      gap: 2rem;
      margin-top: 1rem;
    }

    .rendimiento-charts-container canvas {
      width: 250px !important;
      height: 250px !important;
    }
  </style>
</head>
<body>
  <!-- Menú Lateral -->
  <div id="mySidenav" class="sidenav">
    <button class="closebtn" onclick="closeNav()">&times;</button>
    <a href="#" onclick="mostrarConfiguracion()">Configuración</a>
    <a href="#" onclick="mostrarOperacionesCerradas()">Operaciones Cerradas</a>
    <a href="#" onclick="mostrarResultadosMensuales()">Resultados Mensuales</a>
    <a href="#" onclick="mostrarResultadosHistoricos()">Resultados Históricos</a>
    <a href="#" onclick="mostrarComisionesPagadas()">Comisiones Pagadas</a> <!-- Nuevo enlace -->
  </div>

  <!-- Botón para abrir el Menú Lateral -->
  <button class="open-sidenav-btn" onclick="openNav()"><i class="fa-solid fa-bars"></i></button>

  <!-- Botón para alternar Modo Oscuro/Claro -->
  <button class="toggle-dark-mode" onclick="toggleDarkMode()" title="Cambiar Modo">
    <i class="fa-solid fa-moon"></i>
  </button>

  <header>
    <h1>Portfolio de Inversiones</h1>
  </header>

  <main>
    <!-- Sección de Filtros -->
    <section class="filters">
      <div class="filter-group">
        <label for="monthYear">Mes/Año:</label>
        <input type="month" id="monthYear" onchange="actualizarTabla()">
      </div>

      <div class="filter-group">
        <label for="viewModeSelect">Modo de Rendimiento:</label>
        <select id="viewModeSelect" onchange="actualizarTabla()">
          <option value="DEFAULT">Default</option>
          <option value="MONTHLY">Mensual</option>
          <option value="HISTORICAL">Histórico</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="origenFilter">Origen:</label>
        <select id="origenFilter" onchange="actualizarTabla()">
          <!-- Opciones dinámicas -->
        </select>
      </div>

      <div class="filter-group">
        <label for="tipoFilter">Tipo:</label>
        <select id="tipoFilter" onchange="actualizarTabla()">
          <!-- Opciones dinámicas -->
        </select>
      </div>

      <div class="filter-group">
        <label for="monedaFilter">Moneda:</label>
        <select id="monedaFilter" onchange="actualizarTabla()">
          <!-- Opciones dinámicas -->
        </select>
      </div>
    </section>

    <!-- Sección de Acciones -->
    <section class="actions">
      <!-- Botones Arriba del Resumen -->
      <div class="actions-top">
        <button onclick="mostrarResultadosHistoricos()">Ver Rendimiento Histórico</button>
        <button onclick="mostrarResultadosMensuales()">Ver Rendimiento Mes</button>
        <!-- El botón de configuración ahora está en el menú lateral -->
      </div>

      <!-- Sección de Resumen -->
      <section class="summary">
        <div class="summary-box">
          <h4>Resumen en Pesos</h4>
          <div class="summary-item">
            <span class="summary-label">Total Inversión:</span>
            <span id="summaryContentPesosInversion">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Cierre Mes:</span>
            <span id="summaryContentPesosCierre">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Actual:</span>
            <span id="summaryContentPesosActual">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Diferencia:</span>
            <span id="summaryContentPesosDiferencia">-</span>
          </div>
        </div>
        <div class="summary-box">
          <h4>Resumen en Dólares</h4>
          <div class="summary-item">
            <span class="summary-label">Total Inversión:</span>
            <span id="summaryContentDolaresInversion">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Cierre Mes:</span>
            <span id="summaryContentDolaresCierre">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Total Actual:</span>
            <span id="summaryContentDolaresActual">-</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Diferencia:</span>
            <span id="summaryContentDolaresDiferencia">-</span>
          </div>
        </div>
      </section>

      <!-- Botones Debajo del Resumen -->
      <div class="actions-middle">
        <button onclick="mostrarFormulario()">Agregar Inversión</button>
        <button onclick="mostrarValoresActuales()">Cargar Valores Actuales</button>
        <!-- El botón de ver operaciones cerradas ahora está en el menú lateral -->
      </div>

      <!-- Botones Debajo con Diferente Color -->
      <div class="actions-bottom">
        <button class="export-button" onclick="exportarExcel()">Exportar Portafolio Completo a Excel</button>
        <button class="chart-button" onclick="abrirModalRendimiento()">Ver Gráfico de Rendimiento</button>
      </div>

      <!-- Botones Extra: Descargar y Subir localStorage -->
      <div class="actions-extra">
        <button onclick="descargarLocalStorage()" title="Descargar Datos">
          <i class="fa-solid fa-download"></i>
        </button>
        <button onclick="subirLocalStorage()" title="Subir Datos">
          <i class="fa-solid fa-upload"></i>
        </button>
        <!-- Input para subir archivo Excel -->
        <input type="file" id="uploadLocalStorageInput" accept=".xlsx, .xls" style="display:none" onchange="procesarArchivoLocalStorage(event)">
      </div>
    </section>

    <!-- Sección de Tablas -->
    <section class="tables">
      <!-- Tabla Principal -->
      <table>
        <thead>
          <tr>
            <th>Fecha Adquisición</th>
            <th>Nombre</th>
            <th>Moneda</th>
            <th>Q Cuotaparte</th>
            <th>Precio Compra</th>
            <th>Valor Inversión</th>
            <th>Precio Cierre Último Mes</th>
            <th>Valor Actual</th>
            <th>Diferencia</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="portfolioBody">
          <!-- Contenido dinámico -->
        </tbody>
      </table>

      <!-- Formulario para Agregar/Editar Inversión -->
      <div id="newInvestmentForm" class="form-section">
        <form id="investmentForm" onsubmit="guardarInversion(event)">
          <input type="hidden" id="editIndex" value="-1">
          <h3>Agregar/Editar Inversión</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="fecha">Fecha de Adquisición:</label>
              <input type="date" id="fecha" required>
            </div>
            <div class="form-group">
              <label for="nombre">Nombre de la Inversión:</label>
              <input type="text" id="nombre" required>
            </div>
            <div class="form-group">
              <label for="moneda">Moneda:</label>
              <select id="moneda" required>
                <!-- Opciones dinámicas -->
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="cuotaparte">Q Cuotaparte:</label>
              <input type="number" id="cuotaparte" step="0.0000001" required>
            </div>
            <div class="form-group">
              <label for="precio">Precio de Compra:</label>
              <input type="number" id="precio" step="0.0000001" required>
            </div>
            <div class="form-group comisiones-pagadas">
              <label for="comisionesPagadas">Comisiones Pagadas:</label>
              <input type="number" id="comisionesPagadas" step="0.01" min="0" max="999999.99" placeholder="0.00">
            </div>
            <div class="form-group" style="max-width: 25ch;">
              <label for="origenInv">Origen:</label>
              <select id="origenInv" required>
                <!-- Opciones dinámicas -->
              </select>
            </div>
            <div class="form-group" style="max-width: 25ch;">
              <label for="tipoInv">Tipo:</label>
              <select id="tipoInv" required>
                <!-- Opciones dinámicas -->
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit">Guardar</button>
            <button type="button" class="cancel-button" onclick="cancelarInversion()">Cancelar</button>
          </div>
        </form>
      </div>

      <!-- Formulario para Procesar Venta -->
      <div id="saleForm" class="form-section">
        <form id="ventaForm" onsubmit="procesarVenta(event)">
          <input type="hidden" id="saleIndex" value="-1">
          <h3>Procesar Venta</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="nombreVenta">Nombre de la Inversión:</label>
              <input type="text" id="nombreVenta" readonly>
            </div>
            <div class="form-group">
              <label for="cuotaparteVenta">Q Cuotaparte a Vender:</label>
              <input type="number" id="cuotaparteVenta" step="0.0000001" readonly>
            </div>
            <div class="form-group">
              <label for="tipoVenta">Tipo de Venta:</label>
              <select id="tipoVenta" onchange="toggleCuotaparteVenta()" required>
                <option value="TOTAL">Total</option>
                <option value="PARCIAL">Parcial</option>
              </select>
            </div>
            <div class="form-group">
              <label for="precioVenta">Precio de Venta:</label>
              <input type="number" id="precioVenta" step="0.0000001" required>
            </div>
            <div class="form-group">
              <label for="fechaVenta">Fecha de Venta:</label>
              <input type="date" id="fechaVenta" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group comisiones-pagadas">
              <label for="comisionesPagadasVenta">Comisiones Pagadas:</label>
              <input type="number" id="comisionesPagadasVenta" step="0.01" min="0" max="999999.99" placeholder="0.00">
            </div>
          </div>
          <div class="form-actions">
            <button type="submit">Procesar Venta</button>
            <button type="button" class="cancel-button" onclick="cancelarVenta()">Cancelar</button>
          </div>
        </form>
      </div>

      <!-- ... (otros modales y secciones) ... -->

      <!-- Configuración Modal -->
      <div id="configuracionModal" class="modal">
        <div class="modal-content">
          <button class="close-button" onclick="cerrarConfiguracion()">&times;</button>
          <h3>Configuración</h3>
          <form id="configuracionForm" onsubmit="guardarConfiguracion(event)">
            <h4>Orígenes</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="configOrigenSelect">Eliminar Origen:</label>
                <select id="configOrigenSelect">
                  <!-- Opciones dinámicas -->
                </select>
              </div>
              <div class="form-group">
                <label for="nuevoOrigen">Agregar Origen:</label>
                <input type="text" id="nuevoOrigen" placeholder="Nuevo Origen">
              </div>
            </div>
            <button type="button" onclick="agregarOrigen()">Agregar Origen</button>
            <button type="button" onclick="eliminarOrigen()">Eliminar Origen</button>

            <h4>Tipos</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="configTipoSelect">Eliminar Tipo:</label>
                <select id="configTipoSelect">
                  <!-- Opciones dinámicas -->
                </select>
              </div>
              <div class="form-group">
                <label for="nuevoTipo">Agregar Tipo:</label>
                <input type="text" id="nuevoTipo" placeholder="Nuevo Tipo">
              </div>
            </div>
            <button type="button" onclick="agregarTipo()">Agregar Tipo</button>
            <button type="button" onclick="eliminarTipo()">Eliminar Tipo</button>

            <h4>Monedas</h4>
            <div class="form-row">
              <div class="form-group">
                <label for="configMonedaSelect">Eliminar Moneda:</label>
                <select id="configMonedaSelect">
                  <!-- Opciones dinámicas -->
                </select>
              </div>
              <div class="form-group">
                <label for="nuevoMoneda">Agregar Moneda:</label>
                <input type="text" id="nuevoMoneda" placeholder="Nueva Moneda">
              </div>
            </div>
            <button type="button" onclick="agregarMoneda()">Agregar Moneda</button>
            <button type="button" onclick="eliminarMoneda()">Eliminar Moneda</button>

            <div class="form-actions">
              <button type="submit">Guardar Configuración</button>
              <button type="button" class="cancel-button" onclick="cerrarConfiguracion()">Cancelar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Operaciones Cerradas Modal -->
      <div id="closedOperationsModal" class="modal">
        <div class="modal-content">
          <button class="close-button" onclick="cerrarModalOperaciones()">&times;</button>
          <h3>Operaciones Cerradas</h3>
          <table>
            <thead>
              <tr>
                <th>Fecha Venta</th>
                <th>Nombre</th>
                <th>Moneda</th>
                <th>Q Cuotaparte</th>
                <th>Precio Compra</th>
                <th>Precio Venta</th>
                <th>Comisiones Pagadas</th>
                <th>Valor a Reinvertir</th>
                <th>Rendimiento</th>
              </tr>
            </thead>
            <tbody id="closedOperationsBody">
              <!-- Contenido dinámico -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Valores Mensuales Modal -->
      <div id="monthlyResultsModal" class="modal">
        <div class="modal-content">
          <button class="close-button" onclick="cerrarResultadosMensuales()">&times;</button>
          <h3>Resultados Mensuales</h3>
          <div id="monthlyResultsContent">
            <!-- Contenido dinámico -->
          </div>
        </div>
      </div>

      <!-- Resultados Históricos Modal -->
      <div id="historicalResultsModal" class="modal">
        <div class="modal-content">
          <button class="close-button" onclick="cerrarResultadosHistoricos()">&times;</button>
          <h3>Resultados Históricos</h3>
          <div id="historicalResultsContent">
            <!-- Contenido dinámico -->
          </div>
        </div>
      </div>

      <!-- Comisiones Pagadas Modal -->
      <div id="comisionesPagadasModal" class="modal">
        <div class="modal-content">
          <button class="close-button" onclick="cerrarComisionesPagadas()">&times;</button>
          <h3>Comisiones Pagadas</h3>
          <div id="comisionesPagadasContent">
            <!-- Contenido dinámico -->
          </div>
        </div>
      </div>

      <!-- Gráfico Rendimiento Modal -->
      <div id="rendimientoModal" class="modal">
        <div class="modal-content">
          <button class="close-button" onclick="cerrarGraficoRendimiento()">&times;</button>
          <h3>Gráfico de Rendimiento</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="monthYearRendimiento">Mes/Año:</label>
              <input type="month" id="monthYearRendimiento" onchange="generarGraficoRendimiento()">
            </div>
            <div class="form-group">
              <label for="toggleChartMode">Modo:</label>
              <div style="display: flex; align-items: center;">
                <input type="checkbox" id="toggleChartMode" onchange="generarGraficoRendimiento()">
                <label id="toggleChartLabel" for="toggleChartMode" style="margin-left: 0.5rem;">Mensual</label>
              </div>
            </div>
          </div>
          <div class="rendimiento-charts-container">
            <canvas id="chartPesos"></canvas>
            <canvas id="chartDolares"></canvas>
          </div>
        </div>
      </div>

      <!-- ... (otros modales y secciones) ... -->

      <!-- AQUÍ COMIENZA TODO EL JAVASCRIPT DE LA APLICACIÓN -->
      <script>
        /**************************************************************
         * REGISTRO DE PLUGINS DE CHART.JS
         **************************************************************/
        Chart.register(ChartDataLabels);

        /**************************************************************
         * VARIABLES GLOBALES
         **************************************************************/
        let inversiones = [];
        let operacionesCerradas = [];
        let valoresMensuales = {};

        let configOrigen = ["LOCAL","EXTRANJERO"];
        let configTipo = ["ACCIONES","BONOS","FONDOS MUTUOS","CRIPTO"];
        let configMoneda = ["PESOS","DOLARES"];

        let totalesGlobal = null;

        // Variables para los gráficos
        let doughnutPesos = null;
        let doughnutDolares = null;

        // Colores para flechas, etc.
        const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success').trim();
        const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger').trim();

        /**************************************************************
         * UTILIDADES
         **************************************************************/
        function escapeHTML(str) {
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        }
        function formatNumber(num, decimals = 7) {
          return Number(num).toFixed(decimals);
        }
        function formatCurrency(num, moneda='PESOS', decimals = 2) {
          if (num === '-' || isNaN(num)) return '0';
          const options = { minimumFractionDigits: decimals, maximumFractionDigits: decimals };
          const f = new Intl.NumberFormat('es-AR', options).format(num);
          return (moneda === 'DOLARES') ? 'U$D ' + f : '$ ' + f;
        }
        function calculatePercentage(actual, original) {
          if (!original || original === 0) return null;
          return ((actual - original) / original * 100).toFixed(2);
        }
        function getDifferenceArrow(isPositive) {
          const arrowPath = isPositive ? 'M6 1l5 5H1l5-5' : 'M6 11L1 6h10l-5 5';
          const fillColor = isPositive ? successColor : dangerColor;
          return `<svg width="12" height="12" viewBox="0 0 12 12" style="display:inline-block; margin-left:4px;">
                    <path d="${arrowPath}" fill="${fillColor}"/>
                  </svg>`;
        }

        function getPreviousMonth(currentMonth) {
          const [year, month] = currentMonth.split('-').map(Number);
          let prevYear = year;
          let prevMonth = month - 1;
          if (prevMonth < 1) { prevMonth = 12; prevYear--; }
          return `${prevYear}-${prevMonth < 10 ? '0' + prevMonth : prevMonth}`;
        }
        function calcularDiasDesdeHoy(fecha) {
          const hoy = new Date();
          const fechaInv = new Date(fecha);
          const diffMs = hoy - fechaInv;
          const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
          return diffDias;
        }

        /**************************************************************
         * LOCAL STORAGE
         **************************************************************/
        function cargarDatos(){
          const storedInversiones = JSON.parse(localStorage.getItem('inversiones'));
          const storedOperaciones = JSON.parse(localStorage.getItem('operacionesCerradas'));
          const storedValores = JSON.parse(localStorage.getItem('valoresMensuales'));
          const storedOrigen = JSON.parse(localStorage.getItem('configOrigen'));
          const storedTipo = JSON.parse(localStorage.getItem('configTipo'));
          const storedMoneda = JSON.parse(localStorage.getItem('configMoneda'));

          if(storedInversiones) inversiones = storedInversiones;
          if(storedOperaciones) operacionesCerradas = storedOperaciones;
          if(storedValores) valoresMensuales = storedValores;
          if(storedOrigen && storedOrigen.length > 0) configOrigen = storedOrigen;
          if(storedTipo && storedTipo.length > 0) configTipo = storedTipo;
          if(storedMoneda && storedMoneda.length > 0) configMoneda = storedMoneda;
        }
        function guardarDatos(){
          localStorage.setItem('inversiones', JSON.stringify(inversiones));
          localStorage.setItem('operacionesCerradas', JSON.stringify(operacionesCerradas));
          localStorage.setItem('valoresMensuales', JSON.stringify(valoresMensuales));
          localStorage.setItem('configOrigen', JSON.stringify(configOrigen));
          localStorage.setItem('configTipo', JSON.stringify(configTipo));
          localStorage.setItem('configMoneda', JSON.stringify(configMoneda));
        }

        /**************************************************************
         * SELECTS & CONFIG
         **************************************************************/
        function actualizarSelects(){
          const origenFilter = document.getElementById('origenFilter');
          const origenInv = document.getElementById('origenInv');
          const tipoFilter = document.getElementById('tipoFilter');
          const tipoInv = document.getElementById('tipoInv');
          const monedaFilter = document.getElementById('monedaFilter');
          const moneda = document.getElementById('moneda');

          origenFilter.innerHTML = '<option value="">Todos</option>';
          origenInv.innerHTML = '<option value="">Seleccione Origen</option>';
          tipoFilter.innerHTML = '<option value="">Todos</option>';
          tipoInv.innerHTML = '<option value="">Seleccione Tipo</option>';
          monedaFilter.innerHTML = '<option value="">Todos</option>';
          moneda.innerHTML = '<option value="">Seleccione Moneda</option>';

          configOrigen.forEach(o => {
            const optF = document.createElement('option');
            optF.value = o; optF.textContent = o;
            origenFilter.appendChild(optF);

            const optI = document.createElement('option');
            optI.value = o; optI.textContent = o;
            origenInv.appendChild(optI);
          });

          configTipo.forEach(t => {
            const optF = document.createElement('option');
            optF.value = t; optF.textContent = t;
            tipoFilter.appendChild(optF);

            const optI = document.createElement('option');
            optI.value = t; optI.textContent = t;
            tipoInv.appendChild(optI);
          });

          configMoneda.forEach(m => {
            const optF = document.createElement('option');
            optF.value = m; optF.textContent = m;
            monedaFilter.appendChild(optF);

            const optI = document.createElement('option');
            optI.value = m; optI.textContent = m;
            moneda.appendChild(optI);
          });
        }

        /**************************************************************
         * MENÚ LATERAL
         **************************************************************/
        function openNav() {
          document.getElementById("mySidenav").style.width = "250px";
          document.querySelector('main').style.marginLeft = "250px";
        }

        function closeNav() {
          document.getElementById("mySidenav").style.width = "0";
          document.querySelector('main').style.marginLeft= "0";
        }

        /**************************************************************
         * CONFIGURACIÓN MODAL
         **************************************************************/
        function mostrarConfiguracion(){
          actualizarConfigModal();
          abrirConfiguracionModal();
        }

        function actualizarConfigModal(){
          // Actualizar selects en el modal de configuración
          const configOrigenSelect = document.getElementById('configOrigenSelect');
          const configTipoSelect = document.getElementById('configTipoSelect');
          const configMonedaSelect = document.getElementById('configMonedaSelect');

          configOrigenSelect.innerHTML = '<option value="">Seleccione Origen</option>';
          configTipoSelect.innerHTML = '<option value="">Seleccione Tipo</option>';
          configMonedaSelect.innerHTML = '<option value="">Seleccione Moneda</option>';

          configOrigen.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o; opt.textContent = o;
            configOrigenSelect.appendChild(opt);
          });

          configTipo.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t; opt.textContent = t;
            configTipoSelect.appendChild(opt);
          });

          configMoneda.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = m;
            configMonedaSelect.appendChild(opt);
          });
        }

        function abrirConfiguracionModal(){
          document.getElementById('configuracionModal').classList.add('visible');
          closeNav(); // Cerrar el menú lateral al abrir el modal
        }

        function cerrarConfiguracion(){
          document.getElementById('configuracionModal').classList.remove('visible');
          document.getElementById('configuracionForm').reset();
        }

        function agregarOrigen(){
          const nuevoOrigen = document.getElementById('nuevoOrigen').value.trim().toUpperCase();
          if(nuevoOrigen === ''){
            alert('Ingrese un origen válido.');
            return;
          }
          if(configOrigen.includes(nuevoOrigen)){
            alert('El origen ya existe.');
            return;
          }
          configOrigen.push(nuevoOrigen);
          actualizarSelects();
          actualizarConfigModal();
          document.getElementById('nuevoOrigen').value = '';
          alert('Origen agregado exitosamente.');
        }

        function eliminarOrigen(){
          const selectedOrigen = document.getElementById('configOrigenSelect').value;
          if(selectedOrigen === ''){
            alert('Seleccione un origen para eliminar.');
            return;
          }
          if(confirm(`¿Está seguro de eliminar el origen "${selectedOrigen}"?`)){
            configOrigen = configOrigen.filter(o => o !== selectedOrigen);
            actualizarSelects();
            actualizarConfigModal();
            alert('Origen eliminado exitosamente.');
          }
        }

        function agregarTipo(){
          const nuevoTipo = document.getElementById('nuevoTipo').value.trim().toUpperCase();
          if(nuevoTipo === ''){
            alert('Ingrese un tipo válido.');
            return;
          }
          if(configTipo.includes(nuevoTipo)){
            alert('El tipo ya existe.');
            return;
          }
          configTipo.push(nuevoTipo);
          actualizarSelects();
          actualizarConfigModal();
          document.getElementById('nuevoTipo').value = '';
          alert('Tipo agregado exitosamente.');
        }

        function eliminarTipo(){
          const selectedTipo = document.getElementById('configTipoSelect').value;
          if(selectedTipo === ''){
            alert('Seleccione un tipo para eliminar.');
            return;
          }
          if(confirm(`¿Está seguro de eliminar el tipo "${selectedTipo}"?`)){
            configTipo = configTipo.filter(t => t !== selectedTipo);
            actualizarSelects();
            actualizarConfigModal();
            alert('Tipo eliminado exitosamente.');
          }
        }

        function agregarMoneda(){
          const nuevaMoneda = document.getElementById('nuevoMoneda').value.trim().toUpperCase();
          if(nuevaMoneda === ''){
            alert('Ingrese una moneda válida.');
            return;
          }
          if(configMoneda.includes(nuevaMoneda)){
            alert('La moneda ya existe.');
            return;
          }
          configMoneda.push(nuevaMoneda);
          actualizarSelects();
          actualizarConfigModal();
          document.getElementById('nuevoMoneda').value = '';
          alert('Moneda agregada exitosamente.');
        }

        function eliminarMoneda(){
          const selectedMoneda = document.getElementById('configMonedaSelect').value;
          if(selectedMoneda === ''){
            alert('Seleccione una moneda para eliminar.');
            return;
          }
          if(confirm(`¿Está seguro de eliminar la moneda "${selectedMoneda}"?`)){
            configMoneda = configMoneda.filter(m => m !== selectedMoneda);
            actualizarSelects();
            actualizarConfigModal();
            alert('Moneda eliminada exitosamente.');
          }
        }

        function guardarConfiguracion(e){
          e.preventDefault();
          guardarDatos();
          alert('Configuración guardada exitosamente.');
          cerrarConfiguracion();
        }

        /**************************************************************
         * MODO OSCURO
         **************************************************************/
        function toggleDarkMode(){
          document.body.classList.toggle('dark-mode');
          const toggleBtn = document.querySelector('.toggle-dark-mode i');
          if(document.body.classList.contains('dark-mode')){
            toggleBtn.classList.remove('fa-moon');
            toggleBtn.classList.add('fa-sun');
          } else{
            toggleBtn.classList.remove('fa-sun');
            toggleBtn.classList.add('fa-moon');
          }
        }

        /**************************************************************
         * MODO: MENSUAL / HISTÓRICO / DEFAULT (para la tabla principal)
         **************************************************************/
        function getPrecioCompraMensual(inv, selectedMonth){
          const invMonth = inv.fecha.slice(0,7);
          if(invMonth === selectedMonth){
            return valoresMensuales[selectedMonth]?.values[inv.nombre] || inv.precio;
          } else{
            const prevMonth = getPreviousMonth(selectedMonth);
            const valAnterior = valoresMensuales[prevMonth]?.values[inv.nombre];
            return (valAnterior && valAnterior > 0) ? valAnterior : inv.precio;
          }
        }
        function getPrecioCompraHistorico(inv, selectedMonth){
          return inv.precio;
        }

        /**************************************************************
         * ACTUALIZAR TABLA & RESUMEN
         **************************************************************/
        function actualizarTabla(){
          const tbody = document.getElementById('portfolioBody');
          const filtroMoneda = document.getElementById('monedaFilter').value;
          const filtroTipo = document.getElementById('tipoFilter').value;
          const filtroOrigen = document.getElementById('origenFilter').value;
          const selectedMonth = document.getElementById('monthYear').value;
          const viewMode = document.getElementById('viewModeSelect').value;

          tbody.innerHTML = '';

          let filtradas = inversiones.filter(inv => inv.cuotaparte > 0);

          if(filtroMoneda){
            filtradas = filtradas.filter(inv => inv.moneda === filtroMoneda);
          }
          if(filtroTipo){
            filtradas = filtradas.filter(inv => inv.tipo === filtroTipo);
          }
          if(filtroOrigen){
            filtradas = filtradas.filter(inv => inv.origen === filtroOrigen);
          }
          if(selectedMonth){
            filtradas = filtradas.filter(inv => inv.fecha.slice(0,7) <= selectedMonth);
          }

          filtradas.forEach((inv, index) => {
            let precioCompraBase = inv.precio;
            let valorCargado = 0;

            if(viewMode === 'MONTHLY' && selectedMonth && valoresMensuales[selectedMonth]?.closed){
              valorCargado = valoresMensuales[selectedMonth].values[inv.nombre] || 0;
              precioCompraBase = getPrecioCompraMensual(inv, selectedMonth);
            }
            else if(viewMode === 'HISTORICAL'){
              precioCompraBase = getPrecioCompraHistorico(inv, selectedMonth);
              valorCargado = valoresMensuales[selectedMonth]?.values[inv.nombre] || 0;
            }

            // Usar precioCompraBase en lugar de inv.precio
            const valorInversion = inv.cuotaparte * precioCompraBase;

            let valorActual = '-';
            let diferencia = '-';
            let porcentaje = null;

            if(viewMode === 'MONTHLY' && valorCargado > 0){
              valorActual = inv.cuotaparte * valorCargado;
              diferencia = valorActual - valorInversion;
              porcentaje = calculatePercentage(valorActual, valorInversion);
            } else if(viewMode === 'HISTORICAL' && valoresMensuales[selectedMonth]?.closed){
              valorActual = inv.cuotaparte * valorCargado;
              diferencia = valorActual - valorInversion;
              porcentaje = calculatePercentage(valorActual, valorInversion);
            }

            const diffCell = (diferencia !== '-' && diferencia !== null)
              ? (formatCurrency(Math.abs(diferencia), inv.moneda, 2) +
                 (porcentaje ? ` (${Math.abs(porcentaje)}%)` : '') +
                 (diferencia >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false)))
              : '-';

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHTML(inv.fecha)}</td>
              <td>${escapeHTML(inv.nombre)}</td>
              <td>${escapeHTML(inv.moneda)}</td>
              <td class="number-cell">${formatNumber(inv.cuotaparte, 7)}</td>
              <td class="number-cell">${formatNumber(precioCompraBase, 7)}</td>
              <td class="number-cell">${formatCurrency(inv.cuotaparte * inv.precio, inv.moneda, 2)}</td>
              <td class="number-cell">${viewMode === 'MONTHLY' && valorCargado > 0 ? formatCurrency(inv.cuotaparte * valorCargado, inv.moneda, 2) : '-'}</td>
              <td class="number-cell">${valorActual !== '-' ? formatCurrency(valorActual, inv.moneda, 2) : '-'}</td>
              <td class="number-cell" style="color:${diferencia >= 0 ? successColor : dangerColor};">${diffCell}</td>
              <td class="acciones">
                <div class="btn-group">
                  <button class="btn btn-edit" title="Editar" onclick="editarInversion(${index})"><i class="fa-solid fa-pen-to-square"></i></button>
                  <button class="btn btn-sell" title="Vender" onclick="venderInversion(${index}, event)"><i class="fa-solid fa-sack-dollar"></i></button>
                </div>
                <button class="btn btn-delete" title="Eliminar" onclick="eliminarInversion(${index})"><i class="fa-solid fa-trash"></i></button>
              </td>
            `;
            tbody.appendChild(tr);
          });

          actualizarResumen(filtradas);
          guardarDatos();
        }
        function actualizarResumen(listaFiltrada){
          const summaryPesosInversion = document.getElementById('summaryContentPesosInversion');
          const summaryPesosCierre = document.getElementById('summaryContentPesosCierre');
          const summaryPesosActual = document.getElementById('summaryContentPesosActual');
          const summaryPesosDiferencia = document.getElementById('summaryContentPesosDiferencia');

          const summaryDolaresInversion = document.getElementById('summaryContentDolaresInversion');
          const summaryDolaresCierre = document.getElementById('summaryContentDolaresCierre');
          const summaryDolaresActual = document.getElementById('summaryContentDolaresActual');
          const summaryDolaresDiferencia = document.getElementById('summaryContentDolaresDiferencia');

          const selectedMonth = document.getElementById('monthYear').value;
          const viewMode = document.getElementById('viewModeSelect').value;

          let totales = {
            PESOS: {valorInversion: 0, valorCierreMes: 0, valorActual: 0},
            DOLARES: {valorInversion: 0, valorCierreMes: 0, valorActual: 0}
          };

          listaFiltrada.forEach(inv => {
            let precioCompraBase = inv.precio;
            let valorCargado = 0;

            if(viewMode === 'MONTHLY' && selectedMonth && valoresMensuales[selectedMonth]?.closed){
              valorCargado = valoresMensuales[selectedMonth].values[inv.nombre] || 0;
              precioCompraBase = getPrecioCompraMensual(inv, selectedMonth);
            }
            else if(viewMode === 'HISTORICAL'){
              precioCompraBase = getPrecioCompraHistorico(inv, selectedMonth);
              valorCargado = valoresMensuales[selectedMonth]?.values[inv.nombre] || 0;
            }

            // Usar precioCompraBase en lugar de inv.precio
            const valorInversion = inv.cuotaparte * precioCompraBase;
            let invActual = 0;
            if(viewMode === 'MONTHLY' && valorCargado > 0){
              invActual = inv.cuotaparte * valorCargado;
            } else if(viewMode === 'HISTORICAL' && valoresMensuales[selectedMonth]?.closed){
              invActual = inv.cuotaparte * valorCargado;
            }

            totales[inv.moneda].valorInversion += valorInversion;
            totales[inv.moneda].valorCierreMes += (viewMode === 'MONTHLY' && valorCargado > 0 ? inv.cuotaparte * valorCargado : 0);
            totales[inv.moneda].valorActual += invActual;
          });

          // PESOS
          const difPes = totales.PESOS.valorActual - totales.PESOS.valorInversion;
          const pctPes = calculatePercentage(totales.PESOS.valorActual, totales.PESOS.valorInversion);

          summaryPesosInversion.innerHTML = formatCurrency(totales.PESOS.valorInversion, 'PESOS', 2);
          summaryPesosCierre.innerHTML = formatCurrency(totales.PESOS.valorCierreMes, 'PESOS', 2);
          summaryPesosActual.innerHTML = formatCurrency(totales.PESOS.valorActual, 'PESOS', 2);
          summaryPesosDiferencia.innerHTML = difPes !== 0
            ? formatCurrency(Math.abs(difPes), 'PESOS', 2) +
              (pctPes ? ` (${Math.abs(pctPes)}%)` : '') +
              (difPes >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false))
            : '-';

          // DOLARES
          const difDol = totales.DOLARES.valorActual - totales.DOLARES.valorInversion;
          const pctDol = calculatePercentage(totales.DOLARES.valorActual, totales.DOLARES.valorInversion);

          summaryDolaresInversion.innerHTML = formatCurrency(totales.DOLARES.valorInversion, 'DOLARES', 2);
          summaryDolaresCierre.innerHTML = formatCurrency(totales.DOLARES.valorCierreMes, 'DOLARES', 2);
          summaryDolaresActual.innerHTML = formatCurrency(totales.DOLARES.valorActual, 'DOLARES', 2);
          summaryDolaresDiferencia.innerHTML = difDol !== 0
            ? formatCurrency(Math.abs(difDol), 'DOLARES', 2) +
              (pctDol ? ` (${Math.abs(pctDol)}%)` : '') +
              (difDol >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false))
            : '-';

          totalesGlobal = totales;
        }

        /**************************************************************
         * FORMULARIO INVERSIÓN
         **************************************************************/
        function mostrarFormulario(){
          document.getElementById('editIndex').value = -1;
          document.getElementById('investmentForm').reset();
          document.getElementById('newInvestmentForm').classList.add('visible');
        }
        function cancelarInversion(){
          document.getElementById('newInvestmentForm').classList.remove('visible');
          document.getElementById('investmentForm').reset();
        }
        function guardarInversion(e){
          e.preventDefault();
          // Validación simple al enviar el formulario
          const fecha = document.getElementById('fecha').value;
          const nombre = document.getElementById('nombre').value.trim();
          const moneda = document.getElementById('moneda').value;
          const cuotaparte = parseFloat(document.getElementById('cuotaparte').value);
          const precio = parseFloat(document.getElementById('precio').value);
          const origen = document.getElementById('origenInv').value;
          const tipo = document.getElementById('tipoInv').value;
          const comisionesPagadas = parseFloat(document.getElementById('comisionesPagadas').value) || 0;

          if(!fecha || !nombre || !moneda || !origen || !tipo || isNaN(cuotaparte) || isNaN(precio)){
            alert('Por favor, complete todos los campos correctamente.');
            return;
          }

          if(cuotaparte <= 0 || precio <= 0){
            alert('Q Cuotaparte y Precio de Compra deben ser números positivos.');
            return;
          }

          const editIndex = parseInt(document.getElementById('editIndex').value);
          const nuevaInversion = {
            fecha,
            nombre,
            moneda,
            cuotaparte,
            precio,
            origen,
            tipo,
            comisionesPagadas, // Nuevo campo
            valorActual: inversiones[editIndex]?.valorActual || 0
          };

          if(editIndex >= 0){
            inversiones[editIndex] = nuevaInversion;
          } else{
            inversiones.push(nuevaInversion);
          }
          actualizarTabla();
          cancelarInversion();
        }
        function editarInversion(index){
          const inv = inversiones[index];
          document.getElementById('fecha').value = inv.fecha;
          document.getElementById('nombre').value = inv.nombre;
          document.getElementById('moneda').value = inv.moneda;
          document.getElementById('cuotaparte').value = inv.cuotaparte;
          document.getElementById('precio').value = inv.precio;
          document.getElementById('origenInv').value = inv.origen;
          document.getElementById('tipoInv').value = inv.tipo;
          document.getElementById('comisionesPagadas').value = inv.comisionesPagadas;
          document.getElementById('editIndex').value = index;
          document.getElementById('newInvestmentForm').classList.add('visible');
        }
        function eliminarInversion(index){
          if(confirm('¿Está seguro de eliminar esta inversión?')){
            inversiones.splice(index,1);
            actualizarTabla();
          }
        }

        /**************************************************************
         * FORM VALORES ACTUALES
         **************************************************************/
        function mostrarValoresActuales(){
          const form = document.getElementById('currentValuesForm');
          const container = document.getElementById('currentValuesContent');
          container.innerHTML = '';
          const monthKey = document.getElementById('currentValuesMonth').value;

          if(!monthKey){
            container.innerHTML = '<p>Seleccione un mes/año</p>';
          } else{
            const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) <= monthKey);
            if(invMes.length === 0){
              container.innerHTML = '<p>No hay inversiones vigentes hasta el mes seleccionado.</p>';
            } else{
              const nombresUnicos = [...new Set(invMes.map(i => i.nombre))];
              nombresUnicos.forEach(n => {
                const existingValue = valoresMensuales[monthKey]?.values[n];
                container.innerHTML += `
                  <div class="form-row">
                    <div class="form-group">
                      <label for="valorActual_${escapeHTML(n)}">${escapeHTML(n)}:</label>
                      <input type="number" id="valorActual_${escapeHTML(n)}"
                             step="0.01"
                             value="${existingValue !== undefined ? existingValue.toFixed(2) : ''}"
                             placeholder="Ingrese valor actual">
                    </div>
                  </div>
                `;
              });
            }
          }
          form.classList.add('visible');

          const isClosed = valoresMensuales[monthKey]?.closed || false;
          document.getElementById('monthClosed').checked = isClosed;
          toggleFieldsBasedOnClosed(isClosed);
        }
        function cerrarValoresActuales(){
          document.getElementById('currentValuesForm').classList.remove('visible');
          document.getElementById('currentValuesFormContent').reset();
        }
        document.getElementById('monthClosed').addEventListener('change', () => {
          const isClosed = document.getElementById('monthClosed').checked;
          toggleFieldsBasedOnClosed(isClosed);
        });
        function toggleFieldsBasedOnClosed(isClosed){
          const container = document.getElementById('currentValuesContent');
          const inputs = container.querySelectorAll('input[type="number"]');
          inputs.forEach(inp => {
            if(isClosed){
              inp.readOnly = true;
              inp.style.backgroundColor = '#f5f5f5';
            } else{
              inp.readOnly = false;
              inp.style.backgroundColor = '';
            }
          });
        }
        function guardarValoresActuales(){
          const monthKey = document.getElementById('currentValuesMonth').value;
          const isClosed = document.getElementById('monthClosed').checked;

          if(!monthKey){
            alert('Por favor, seleccione un mes/año.');
            return;
          }
          const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) <= monthKey);
          if(invMes.length === 0){
            alert('No hay inversiones vigentes hasta el mes seleccionado.');
            return;
          }

          if(!valoresMensuales[monthKey]){
            valoresMensuales[monthKey] = {closed: isClosed, values: {}};
          }
          valoresMensuales[monthKey].closed = isClosed;

          const nombresUnicos = [...new Set(invMes.map(i => i.nombre))];
          nombresUnicos.forEach(n => {
            const input = document.getElementById(`valorActual_${escapeHTML(n)}`);
            if(input){
              const val = parseFloat(input.value || 0);
              if(!isNaN(val) && val > 0){
                valoresMensuales[monthKey].values[n] = parseFloat(val.toFixed(2));
                inversiones.forEach(inv => {
                  if(inv.nombre === n){
                    inv.valorActual = val;
                  }
                });
              }
            }
          });
          actualizarTabla();
          cerrarValoresActuales();
          alert('Valores actuales guardados correctamente.');
          guardarDatos();
        }
        function exportarValoresActuales(){
          const monthKey = document.getElementById('currentValuesMonth').value;
          if(!monthKey){
            alert('Por favor, seleccione un mes/año.');
            return;
          }
          if(!valoresMensuales[monthKey]){
            alert('No hay valores cargados para el mes/año seleccionado.');
            return;
          }

          const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) === monthKey);
          const ws_data = [["Mes/Año", "Nombre de Inversión", "Valor Actual"]];

          invMes.forEach(inv => {
            const valActual = valoresMensuales[monthKey].values[inv.nombre] || '';
            ws_data.push([monthKey, inv.nombre, valActual !== '' ? parseFloat(valActual).toFixed(2) : '']);
          });

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          XLSX.utils.book_append_sheet(wb, ws, `Valores_${monthKey}`);
          XLSX.writeFile(wb, `Valores_Actuales_${monthKey}.xlsx`);
        }

        /**************************************************************
         * DESCARGAR PLANTILLA Y SUBIR VALORES MASIVAMENTE
         **************************************************************/
        function descargarPlantilla(){
          const monthKey = document.getElementById('currentValuesMonth').value;
          if(!monthKey){
            alert('Por favor, seleccione un mes/año antes de descargar la plantilla.');
            return;
          }

          const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) === monthKey);
          if(invMes.length === 0){
            alert('No hay inversiones vigentes en el mes/año seleccionado.');
            return;
          }

          const headers = ["Mes/Año", "Nombre de Inversión", "Valor Actual"];
          const ws_data = [headers];

          invMes.forEach(inv => {
            const valActual = valoresMensuales[monthKey]?.values[inv.nombre] || '';
            ws_data.push([monthKey, inv.nombre, valActual !== '' ? parseFloat(valActual).toFixed(2) : '']);
          });

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          XLSX.utils.book_append_sheet(wb, ws, "Plantilla");
          XLSX.writeFile(wb, `Plantilla_Carga_Valores_${monthKey}.xlsx`);
        }

        function subirValoresMasivamente(){
          document.getElementById('uploadFileInput').click();
        }

        function procesarArchivoSubido(event){
          const file = event.target.files[0];
          if(!file){
            return;
          }
          const reader = new FileReader();
          reader.onload = function(e){
            const data = e.target.result;
            let workbook;
            try {
              workbook = XLSX.read(data, {type: 'binary'});
            } catch(error){
              alert('Error al leer el archivo. Asegúrate de que el formato sea correcto.');
              return;
            }

            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header:1});

            if(jsonData.length < 2){
              alert('El archivo no contiene datos.');
              return;
            }

            const headers = jsonData[0];
            if(headers.includes("Mes/Año") && headers.includes("Nombre de Inversión") && headers.includes("Valor Actual")){
              // Correct format
            } else{
              alert('La plantilla no tiene el formato correcto. Debe incluir "Mes/Año", "Nombre de Inversión" y "Valor Actual".');
              return;
            }

            let valid = true;
            let dataToUpload = [];
            for(let i=1; i < jsonData.length; i++){
              const row = jsonData[i];
              if(row.length < 3){
                continue;
              }
              const mesAnio = row[0];
              const nombreInv = row[1];
              const valorActual = parseFloat(row[2]);

              if(!mesAnio || !nombreInv || isNaN(valorActual) || valorActual <= 0){
                valid = false;
                break;
              }

              const inv = inversiones.find(inv => inv.nombre === nombreInv && inv.fecha.slice(0,7) <= mesAnio);
              if(!inv){
                valid = false;
                break;
              }

              dataToUpload.push({mesAnio, nombreInv, valorActual: parseFloat(valorActual.toFixed(2))});
            }

            if(!valid){
              alert('Los datos del archivo son inválidos o no coinciden con las inversiones vigentes.');
              return;
            }

            if(confirm('Datos validados para subir. ¿Desea proceder?')){
              dataToUpload.forEach(item => {
                if(!valoresMensuales[item.mesAnio]){
                  valoresMensuales[item.mesAnio] = {closed: false, values: {}};
                }
                valoresMensuales[item.mesAnio].values[item.nombreInv] = item.valorActual;
                inversiones.forEach(inv => {
                  if(inv.nombre === item.nombreInv && inv.cuotaparte > 0){
                    inv.valorActual = item.valorActual;
                  }
                });
              });
              actualizarTabla();
              guardarDatos();
              alert('Valores cargados exitosamente.');
              document.getElementById('uploadFileInput').value = '';
            }
          };
          reader.onerror = function(){
            alert('Error al leer el archivo.');
          };
          reader.readAsBinaryString(file);
        }

        /**************************************************************
         * RESULTADOS MENSUALES / HISTÓRICOS (MODALES)
         **************************************************************/
        function mostrarResultadosMensuales(){
          const modal = document.getElementById('monthlyResultsModal');
          const content = document.getElementById('monthlyResultsContent');
          content.innerHTML = '';
          const selectedMonth = document.getElementById('monthYear').value;

          if(!selectedMonth){
            alert('Seleccione un mes/año en los filtros de arriba.');
            return;
          }
          if(!valoresMensuales[selectedMonth]?.closed){
            alert('El mes seleccionado no está cerrado. Cierre el mes antes de ver rendimiento mensual.');
            return;
          }

          const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) <= selectedMonth);
          if(invMes.length === 0){
            content.innerHTML = '<p>No hay inversiones vigentes hasta el mes seleccionado.</p>';
          } else{
            invMes.forEach(inv => {
              let precioCompra;
              if(inv.fecha.slice(0,7) === selectedMonth){
                precioCompra = valoresMensuales[selectedMonth]?.values[inv.nombre] || inv.precio;
              } else{
                const prevMonth = getPreviousMonth(selectedMonth);
                precioCompra = valoresMensuales[prevMonth]?.values[inv.nombre] || inv.precio;
              }

              const valorInversion = inv.cuotaparte * precioCompra;
              const valorActual = inv.valorActual ? inv.cuotaparte * inv.valorActual : 0;
              const diferencia = valorActual - valorInversion;
              const porcentaje = calculatePercentage(valorActual, valorInversion);

              const dias = calcularDiasDesdeHoy(inv.fecha);

              content.innerHTML += `
                <div class="summary-section">
                  <h4>${escapeHTML(inv.nombre)} (${escapeHTML(inv.moneda)}) 
                      - Adquirido: ${inv.fecha} (hace ${dias} días)</h4>
                  <div class="summary-item">
                    <span class="summary-label">Total Inversión:</span>
                    <span class="summary-value">${formatCurrency(valorInversion, inv.moneda, 2)}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Valor Actual:</span>
                    <span class="summary-value">${formatCurrency(valorActual, inv.moneda, 2)}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Rendimiento:</span>
                    <span class="summary-value" style="color:${diferencia >= 0 ? successColor : dangerColor};">
                      ${
                        (diferencia !== 0)
                          ? formatCurrency(Math.abs(diferencia), inv.moneda, 2) +
                            (diferencia >= 0 ? ' (Ganancia)' : ' (Pérdida)') +
                            (porcentaje ? ` (${Math.abs(porcentaje)}%)` : '') +
                            (diferencia >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false))
                          : '-'
                      }
                    </span>
                  </div>
                </div>
              `;
            });
          }
          modal.classList.add('visible');
          closeNav(); // Cerrar el menú lateral al abrir el modal
        }
        function cerrarResultadosMensuales(){
          document.getElementById('monthlyResultsModal').classList.remove('visible');
        }

        function mostrarResultadosHistoricos(){
          const modal = document.getElementById('historicalResultsModal');
          const content = document.getElementById('historicalResultsContent');
          content.innerHTML = '';
          const selectedMonth = document.getElementById('monthYear').value;

          if(!selectedMonth){
            alert('Seleccione un mes/año en los filtros de arriba.');
            return;
          }
          if(!valoresMensuales[selectedMonth]?.closed){
            alert('El mes seleccionado no está cerrado. Cierre el mes antes de ver rendimiento histórico.');
            return;
          }

          const invMes = inversiones.filter(inv => inv.fecha.slice(0,7) <= selectedMonth);
          if(invMes.length === 0){
            content.innerHTML = '<p>No hay inversiones vigentes hasta el mes seleccionado.</p>';
          } else{
            invMes.forEach(inv => {
              let precioCompra = getPrecioCompraHistorico(inv, selectedMonth);
              const valorInversion = inv.cuotaparte * inv.precio;
              const valorActual = inv.valorActual ? inv.cuotaparte * inv.valorActual : 0;
              const diferencia = valorActual - valorInversion;
              const porcentaje = calculatePercentage(valorActual, valorInversion);

              const dias = calcularDiasDesdeHoy(inv.fecha);

              content.innerHTML += `
                <div class="summary-section">
                  <h4>${escapeHTML(inv.nombre)} (${escapeHTML(inv.moneda)}) 
                      - Adquirido: ${inv.fecha} (hace ${dias} días)</h4>
                  <div class="summary-item">
                    <span class="summary-label">Total Inversión:</span>
                    <span class="summary-value">${formatCurrency(valorInversion, inv.moneda, 2)}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Valor Actual:</span>
                    <span class="summary-value">${formatCurrency(valorActual, inv.moneda, 2)}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Rendimiento:</span>
                    <span class="summary-value" style="color:${diferencia >= 0 ? successColor : dangerColor};">
                      ${
                        (diferencia !== 0)
                          ? formatCurrency(Math.abs(diferencia), inv.moneda, 2) +
                            (diferencia >= 0 ? ' (Ganancia)' : ' (Pérdida)') +
                            (porcentaje ? ` (${Math.abs(porcentaje)}%)` : '') +
                            (diferencia >= 0 ? getDifferenceArrow(true) : getDifferenceArrow(false))
                          : '-'
                      }
                    </span>
                  </div>
                </div>
              `;
            });
          }
          modal.classList.add('visible');
          closeNav(); // Cerrar el menú lateral al abrir el modal
        }
        function cerrarResultadosHistoricos(){
          document.getElementById('historicalResultsModal').classList.remove('visible');
        }

        /**************************************************************
         * VENTAS / OPERACIONES CERRADAS
         **************************************************************/
        function venderInversion(index, event){
          if(event) event.preventDefault();

          const inv = inversiones[index];
          document.getElementById('saleIndex').value = index;
          document.getElementById('nombreVenta').value = inv.nombre;
          document.getElementById('cuotaparteVenta').value = inv.cuotaparte;
          document.getElementById('cuotaparteVenta').readOnly = true;
          document.getElementById('tipoVenta').value = 'TOTAL';
          document.getElementById('precioVenta').value = '';
          document.getElementById('fechaVenta').value = new Date().toISOString().split('T')[0];
          document.getElementById('comisionesPagadasVenta').value = '';
          document.getElementById('saleForm').classList.add('visible');
        }
        function toggleCuotaparteVenta(){
          const tipoVenta = document.getElementById('tipoVenta').value;
          const index = parseInt(document.getElementById('saleIndex').value);
          const cuotaparteInput = document.getElementById('cuotaparteVenta');
          if(tipoVenta === 'TOTAL'){
            cuotaparteInput.value = inversiones[index].cuotaparte;
            cuotaparteInput.readOnly = true;
            cuotaparteInput.style.backgroundColor = '#f5f5f5';
          } else{
            cuotaparteInput.value = '';
            cuotaparteInput.readOnly = false;
            cuotaparteInput.style.backgroundColor = '';
          }
        }
        function procesarVenta(e){
          e.preventDefault();

          const index = parseInt(document.getElementById('saleIndex').value);
          const inv = inversiones[index];
          const cuotaparteVenta = parseFloat(document.getElementById('cuotaparteVenta').value);
          const precioVenta = parseFloat(document.getElementById('precioVenta').value);
          const fechaVenta = document.getElementById('fechaVenta').value;
          const comisiones = parseFloat(document.getElementById('comisionesPagadasVenta').value) || 0;

          if(isNaN(cuotaparteVenta) || isNaN(precioVenta)){
            alert('Valores inválidos en cuotaparte o precio de venta.');
            return;
          }
          if(cuotaparteVenta <= 0 || precioVenta <= 0){
            alert('Q Cuotaparte y Precio de Venta deben ser números positivos.');
            return;
          }
          if(!fechaVenta){
            alert('Seleccione una fecha de venta.');
            return;
          }
          if(cuotaparteVenta > inv.cuotaparte){
            alert('No puedes vender más cuotapartes de las que posees.');
            return;
          }

          const valorVentaTotal = precioVenta * cuotaparteVenta;
          const valorAReinvertir = valorVentaTotal - comisiones;
          const valorCompraTotal = inv.precio * cuotaparteVenta;
          const resultado = valorAReinvertir - valorCompraTotal;

          const opCerrada = {
            fecha: fechaVenta,
            nombre: inv.nombre,
            moneda: inv.moneda,
            cuotaparte: cuotaparteVenta,
            precioCompra: inv.precio,
            precioVenta,
            comisiones,
            valorAReinvertir: isNaN(valorAReinvertir) ? 0 : parseFloat(valorAReinvertir.toFixed(2)),
            rendimiento: isNaN(resultado) ? 0 : parseFloat(resultado.toFixed(2))
          };
          operacionesCerradas.push(opCerrada);

          if(document.getElementById('tipoVenta').value === 'PARCIAL'){
            inversiones[index].cuotaparte -= cuotaparteVenta;
          } else{
            inversiones.splice(index, 1);
          }
          actualizarTabla();
          cancelarVenta();
          mostrarOperacionesCerradas();
          guardarDatos();
        }
        function cancelarVenta(){
          document.getElementById('saleForm').classList.remove('visible');
          document.getElementById('ventaForm').reset();
          document.getElementById('saleIndex').value = -1;
        }
        function mostrarOperacionesCerradas(){
          const modal = document.getElementById('closedOperationsModal');
          const tbody = document.getElementById('closedOperationsBody');
          tbody.innerHTML = '';

          let totales = {PESOS: 0, DOLARES: 0};
          operacionesCerradas.forEach(op => {
            totales[op.moneda] += op.rendimiento;
            const valorInversion = op.cuotaparte * op.precioCompra;
            const valorVenta = op.cuotaparte * op.precioVenta;
            const pct = calculatePercentage(op.rendimiento, valorInversion);

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHTML(op.fecha)}</td>
              <td>${escapeHTML(op.nombre)}</td>
              <td>${escapeHTML(op.moneda)}</td>
              <td class="number-cell">${formatNumber(op.cuotaparte, 7)}</td>
              <td class="number-cell">${formatNumber(op.precioCompra, 2)}</td>
              <td class="number-cell">${formatNumber(op.precioVenta, 2)}</td>
              <td class="number-cell">${formatCurrency(op.comisiones, op.moneda, 2)}</td>
              <td class="number-cell">${formatCurrency(op.valorAReinvertir, op.moneda, 2)}</td>
              <td class="number-cell" style="color:${op.rendimiento >= 0 ? successColor : dangerColor}; font-weight:bold;">
                ${formatCurrency(op.rendimiento, op.moneda, 2)}
                ${pct ? ` (${Math.abs(pct)}%)` : ''}
                ${op.rendimiento >= 0 ? '<i class="fa-solid fa-arrow-up"></i>' : '<i class="fa-solid fa-arrow-down"></i>'}
              </td>
            `;
            tbody.appendChild(tr);
          });

          Object.keys(totales).forEach(mon => {
            const labelMon = (mon === 'PESOS') ? 'Pesos' : 'Dólares';
            const trTotal = document.createElement('tr');
            trTotal.innerHTML = `
              <td colspan="8" style="text-align:right; font-weight:bold;">
                Total Resultado en ${labelMon}:
              </td>
              <td class="number-cell" style="color:${totales[mon] >= 0 ? successColor : dangerColor}; font-weight:bold;">
                ${formatCurrency(totales[mon], mon, 2)} (${totales[mon] >= 0 ? 'Ganancia' : 'Pérdida'})
              </td>
            `;
            tbody.appendChild(trTotal);
          });

          modal.classList.add('visible');
          closeNav(); // Cerrar el menú lateral al abrir el modal
        }
        function cerrarModalOperaciones(){
          document.getElementById('closedOperationsModal').classList.remove('visible');
        }

        /**************************************************************
         * EXPORTAR EXCEL
         **************************************************************/
        function exportarExcel(){
          const wb = XLSX.utils.book_new();
          const selectedMonth = document.getElementById('monthYear').value;
          const viewMode = document.getElementById('viewModeSelect').value;

          const portPesos = [["Fecha Adquisición","Nombre","Moneda","Q cuotaparte","Precio Compra","Valor Inversión","Precio Cierre Último Mes","Valor Actual","Diferencia"]];
          const portDolares = [["Fecha Adquisición","Nombre","Moneda","Q cuotaparte","Precio Compra","Valor Inversión","Precio Cierre Último Mes","Valor Actual","Diferencia"]];

          inversiones.forEach(inv => {
            let precioCompraBase = inv.precio;
            let valorCargado = 0;
            if(viewMode === 'MONTHLY' && selectedMonth && valoresMensuales[selectedMonth]?.closed){
              valorCargado = valoresMensuales[selectedMonth].values[inv.nombre] || 0;
              precioCompraBase = getPrecioCompraMensual(inv, selectedMonth);
            }
            else if(viewMode === 'HISTORICAL'){
              precioCompraBase = getPrecioCompraHistorico(inv, selectedMonth);
              valorCargado = valoresMensuales[selectedMonth]?.values[inv.nombre] || 0;
            }

            // Usar precioCompraBase en lugar de inv.precio
            const valorInversion = inv.cuotaparte * precioCompraBase;

            let valorActual = '-';
            let diferencia = '-';
            let porcentaje = null;

            if(viewMode === 'MONTHLY' && valorCargado > 0){
              valorActual = inv.cuotaparte * valorCargado;
              diferencia = valorActual - valorInversion;
              porcentaje = calculatePercentage(valorActual, valorInversion);
            } else if(viewMode === 'HISTORICAL' && valoresMensuales[selectedMonth]?.closed){
              valorActual = inv.cuotaparte * valorCargado;
              diferencia = valorActual - valorInversion;
              porcentaje = calculatePercentage(valorActual, valorInversion);
            }

            const difValue = (diferencia !== '-' && diferencia !== null) ? diferencia : '-';
            const row = [
              inv.fecha,
              inv.nombre,
              inv.moneda,
              inv.cuotaparte.toFixed(7),
              precioCompraBase.toFixed(7), // Usar precioCompraBase
              parseFloat(valorInversion.toFixed(2)),
              viewMode === 'MONTHLY' && valorCargado > 0 ? parseFloat((inv.cuotaparte * valorCargado).toFixed(2)) : '-',
              valorActual !== '-' ? parseFloat(valorActual.toFixed(2)) : '-',
              difValue !== '-' ? parseFloat(difValue.toFixed(2)) : '-'
            ];

            if(inv.moneda === 'PESOS'){
              portPesos.push(row);
            } else{
              portDolares.push(row);
            }
          });

          const ws_portPesos = XLSX.utils.aoa_to_sheet(portPesos);
          XLSX.utils.book_append_sheet(wb, ws_portPesos, "Portafolio Pesos");
          const ws_portDolares = XLSX.utils.aoa_to_sheet(portDolares);
          XLSX.utils.book_append_sheet(wb, ws_portDolares, "Portafolio Dólares");

          // Operaciones Cerradas
          const opPesos = [["Fecha Venta","Nombre","Moneda","Q Cuotaparte","Precio Compra","Precio Venta","Comisiones Pagadas","Valor a Reinvertir","Rendimiento"]];
          const opDolares = [["Fecha Venta","Nombre","Moneda","Q Cuotaparte","Precio Compra","Precio Venta","Comisiones Pagadas","Valor a Reinvertir","Rendimiento"]];
          operacionesCerradas.forEach(op => {
            const fila = [
              op.fecha,
              op.nombre,
              op.moneda,
              op.cuotaparte.toFixed(7),
              op.precioCompra.toFixed(2),
              op.precioVenta.toFixed(2),
              parseFloat(op.comisiones.toFixed(2)),
              parseFloat(op.valorAReinvertir.toFixed(2)),
              parseFloat(op.rendimiento.toFixed(2))
            ];
            if(op.moneda === 'PESOS'){
              opPesos.push(fila);
            } else{
              opDolares.push(fila);
            }
          });
          const ws_opPesos = XLSX.utils.aoa_to_sheet(opPesos);
          XLSX.utils.book_append_sheet(wb, ws_opPesos, "Operaciones Cerradas Pesos");
          const ws_opDolares = XLSX.utils.aoa_to_sheet(opDolares);
          XLSX.utils.book_append_sheet(wb, ws_opDolares, "Operaciones Cerradas Dólares");

          // Valores Mensuales
          const valPesos = [["Mes/Año","Nombre Inversión","Valor Actual"]];
          const valDolares = [["Mes/Año","Nombre Inversión","Valor Actual"]];
          Object.keys(valoresMensuales).sort().forEach(mKey => {
            Object.keys(valoresMensuales[mKey].values).forEach(nombre => {
              const inv = inversiones.find(i => i.nombre === nombre);
              if(inv){
                const row = [mKey, nombre, parseFloat(valoresMensuales[mKey].values[nombre].toFixed(2))];
                if(inv.moneda === 'PESOS') valPesos.push(row);
                else valDolares.push(row);
              }
            });
          });
          const ws_valPesos = XLSX.utils.aoa_to_sheet(valPesos);
          XLSX.utils.book_append_sheet(wb, ws_valPesos, "Valores Mensuales Pesos");
          const ws_valDolares = XLSX.utils.aoa_to_sheet(valDolares);
          XLSX.utils.book_append_sheet(wb, ws_valDolares, "Valores Mensuales Dólares");

          // Resumen
          if(totalesGlobal){
            const pes = totalesGlobal.PESOS;
            const dol = totalesGlobal.DOLARES;
            const difPes = pes.valorActual - pes.valorInversion;
            const difDol = dol.valorActual - dol.valorInversion;

            const resPesos = [
              ["Resumen de Inversiones en Pesos"],
              ["Categoría","Valor"],
              ["Total Inversión", parseFloat(pes.valorInversion.toFixed(2))],
              ["Total Cierre Mes", parseFloat(pes.valorCierreMes.toFixed(2))],
              ["Total Actual", parseFloat(pes.valorActual.toFixed(2))],
              ["Diferencia", parseFloat(difPes.toFixed(2))]
            ];
            const resDolares = [
              ["Resumen de Inversiones en Dólares"],
              ["Categoría","Valor"],
              ["Total Inversión", parseFloat(dol.valorInversion.toFixed(2))],
              ["Total Cierre Mes", parseFloat(dol.valorCierreMes.toFixed(2))],
              ["Total Actual", parseFloat(dol.valorActual.toFixed(2))],
              ["Diferencia", parseFloat(difDol.toFixed(2))]
            ];

            const ws_resPesos = XLSX.utils.aoa_to_sheet(resPesos);
            XLSX.utils.book_append_sheet(wb, ws_resPesos, "Resumen Pesos");
            const ws_resDolares = XLSX.utils.aoa_to_sheet(resDolares);
            XLSX.utils.book_append_sheet(wb, ws_resDolares, "Resumen Dólares");
          }

          XLSX.writeFile(wb, "Portfolio_Inversiones_Completo.xlsx");
        }

        /**************************************************************
         * GRÁFICO RENDIMIENTO (Con toggle: Mensual / Histórico)
         **************************************************************/
        function abrirModalRendimiento(){
          const toggle = document.getElementById('toggleChartMode');
          const lbl = document.getElementById('toggleChartLabel');
          lbl.textContent = toggle.checked ? 'Mensual' : 'Histórico';

          document.getElementById('rendimientoModal').classList.add('visible');
          generarGraficoRendimiento();
          closeNav(); // Cerrar el menú lateral al abrir el modal
        }
        function cerrarGraficoRendimiento(){
          document.getElementById('rendimientoModal').classList.remove('visible');
        }

        function generarGraficoRendimiento(){
          const inputMonth = document.getElementById('monthYearRendimiento').value;
          const toggleChart = document.getElementById('toggleChartMode');
          const lbl = document.getElementById('toggleChartLabel');

          lbl.textContent = toggleChart.checked ? 'Mensual' : 'Histórico';

          if(!inputMonth){
            if(doughnutPesos) doughnutPesos.destroy();
            if(doughnutDolares) doughnutDolares.destroy();
            return;
          }

          const isMonthly = toggleChart.checked;

          const listaFiltrada = inversiones.filter(inv => inv.fecha.slice(0,7) <= inputMonth);
          if(listaFiltrada.length === 0){
            if(doughnutPesos) doughnutPesos.destroy();
            if(doughnutDolares) doughnutDolares.destroy();
            return;
          }

          function calcPrecioMensual(inv){
            const invMonth = inv.fecha.slice(0,7);
            if(invMonth === inputMonth){
              return valoresMensuales[inputMonth]?.values[inv.nombre] || inv.precio;
            } else{
              const prevMonth = getPreviousMonth(inputMonth);
              const valAnterior = valoresMensuales[prevMonth]?.values[inv.nombre];
              return (valAnterior && valAnterior > 0) ? valAnterior : inv.precio;
            }
          }
          function calcPrecioHistorico(inv){
            return inv.precio;
          }

          let distPesos = {};
          let distDolares = {};

          const tiposVigentes = [...new Set(listaFiltrada.map(i => i.tipo))];
          tiposVigentes.forEach(t => {
            distPesos[t] = 0;
            distDolares[t] = 0;
          });

          listaFiltrada.forEach(inv => {
            let precioBase = isMonthly ? calcPrecioMensual(inv) : calcPrecioHistorico(inv);
            let valorCargado = 0;
            if(isMonthly && valoresMensuales[inputMonth]?.closed){
              valorCargado = valoresMensuales[inputMonth].values[inv.nombre] || 0;
            }
            const valorInversion = inv.cuotaparte * precioBase;
            let valorActual = 0;
            if(isMonthly && valorCargado > 0){
              valorActual = inv.cuotaparte * valorCargado;
            } else if(!isMonthly && valoresMensuales[inputMonth]?.closed){
              valorActual = inv.cuotaparte * precioBase;
            }
            const total = valorActual > 0 ? valorActual : valorInversion;

            if(inv.moneda === 'PESOS'){
              distPesos[inv.tipo] += total;
            } else{
              distDolares[inv.tipo] += total;
            }
          });

          const labelsPesos = [];
          const dataPesos = [];
          Object.keys(distPesos).forEach(tipo => {
            if(distPesos[tipo] > 0){
              labelsPesos.push(tipo);
              dataPesos.push(parseFloat(distPesos[tipo].toFixed(2)));
            }
          });
          const labelsDolares = [];
          const dataDolares = [];
          Object.keys(distDolares).forEach(tipo => {
            if(distDolares[tipo] > 0){
              labelsDolares.push(tipo);
              dataDolares.push(parseFloat(distDolares[tipo].toFixed(2)));
            }
          });

          const chartColors = [
            '#3498db','#e67e22','#9b59b6','#f1c40f',
            '#1abc9c','#2ecc71','#34495e','#c0392b'
          ];

          if(doughnutPesos) doughnutPesos.destroy();
          if(doughnutDolares) doughnutDolares.destroy();

          const ctxPesos = document.getElementById('chartPesos').getContext('2d');
          const ctxDolares = document.getElementById('chartDolares').getContext('2d');

          doughnutPesos = new Chart(ctxPesos, {
            type: 'doughnut',
            data: {
              labels: labelsPesos,
              datasets: [{
                data: dataPesos,
                backgroundColor: chartColors.slice(0, labelsPesos.length)
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '60%',
              plugins: {
                legend: { display: false },
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  offset: 15,
                  color: '#444',
                  font: { weight: 'bold' },
                  formatter: function(value, context){
                    let total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                    if(value > 0){
                      let pct = ((value / total) * 100).toFixed(1) + '%';
                      return pct;
                    }
                    return '';
                  }
                }
              }
            },
            plugins: [ChartDataLabels]
          });

          doughnutDolares = new Chart(ctxDolares, {
            type: 'doughnut',
            data: {
              labels: labelsDolares,
              datasets: [{
                data: dataDolares,
                backgroundColor: chartColors.slice(labelsPesos.length, labelsPesos.length + labelsDolares.length)
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '60%',
              plugins: {
                legend: { display: false },
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  offset: 15,
                  color: '#444',
                  font: { weight: 'bold' },
                  formatter: function(value, context){
                    let total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                    if(value > 0){
                      let pct = ((value / total) * 100).toFixed(1) + '%';
                      return pct;
                    }
                    return '';
                  }
                }
              }
            },
            plugins: [ChartDataLabels]
          });
        }

        /**************************************************************
         * FUNCIONALIDADES ADICIONALES: Descargar y Subir localStorage
         **************************************************************/
        function descargarLocalStorage(){
          const dataToExport = {
            inversiones,
            operacionesCerradas,
            valoresMensuales,
            configOrigen,
            configTipo,
            configMoneda
          };

          const ws_data = [["Inversiones", "Operaciones Cerradas", "Valores Mensuales", "ConfigOrigen", "ConfigTipo", "ConfigMoneda"]];

          ws_data.push([
            JSON.stringify(dataToExport.inversiones),
            JSON.stringify(dataToExport.operacionesCerradas),
            JSON.stringify(dataToExport.valoresMensuales),
            JSON.stringify(dataToExport.configOrigen),
            JSON.stringify(dataToExport.configTipo),
            JSON.stringify(dataToExport.configMoneda)
          ]);

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(ws_data);
          XLSX.utils.book_append_sheet(wb, ws, "localStorage");
          XLSX.writeFile(wb, "Portfolio_LocalStorage_Data.xlsx");

          alert('Descarga completada correctamente.');
        }

        function subirLocalStorage(){
          document.getElementById('uploadLocalStorageInput').click();
        }

        function procesarArchivoLocalStorage(event){
          const file = event.target.files[0];
          if(!file){
            return;
          }
          const reader = new FileReader();
          reader.onload = function(e){
            const data = e.target.result;
            let workbook;
            try {
              workbook = XLSX.read(data, {type: 'binary'});
            } catch(error){
              alert('Error al leer el archivo. Asegúrate de que el formato sea correcto.');
              return;
            }

            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header:1});

            if(jsonData.length < 2){
              alert('El archivo no contiene datos.');
              return;
            }

            const headers = jsonData[0];
            if(headers.length < 6 ||
               headers[0] !== "Inversiones" ||
               headers[1] !== "Operaciones Cerradas" ||
               headers[2] !== "Valores Mensuales" ||
               headers[3] !== "ConfigOrigen" ||
               headers[4] !== "ConfigTipo" ||
               headers[5] !== "ConfigMoneda"){
              alert('La plantilla no tiene el formato correcto. Debe incluir las columnas: "Inversiones", "Operaciones Cerradas", "Valores Mensuales", "ConfigOrigen", "ConfigTipo", "ConfigMoneda".');
              return;
            }

            const dataRow = jsonData[1];
            if(dataRow.length < 6){
              alert('La plantilla no tiene suficientes datos.');
              return;
            }

            try {
              inversiones = JSON.parse(dataRow[0]);
              operacionesCerradas = JSON.parse(dataRow[1]);
              valoresMensuales = JSON.parse(dataRow[2]);
              configOrigen = JSON.parse(dataRow[3]);
              configTipo = JSON.parse(dataRow[4]);
              configMoneda = JSON.parse(dataRow[5]);

              guardarDatos();

              actualizarSelects();
              actualizarConfigModal();
              actualizarTabla();

              cerrarConfiguracion();
              alert('Subida completada correctamente.');
              document.getElementById('uploadLocalStorageInput').value = '';
            } catch(error){
              alert('Error al procesar los datos del archivo.');
            }
          };
          reader.onerror = function(){
            alert('Error al leer el archivo.');
          };
          reader.readAsBinaryString(file);
        }

        /**************************************************************
         * RESULTADOS MENSUALES / HISTÓRICOS (MODALES)
         **************************************************************/
        // Ya implementado anteriormente

        /**************************************************************
         * VENTAS / OPERACIONES CERRADAS
         **************************************************************/
        // Ya implementado anteriormente

        /**************************************************************
         * EXPORTAR EXCEL
         **************************************************************/
        // Ya implementado anteriormente

        /**************************************************************
         * GRÁFICO RENDIMIENTO (Con toggle: Mensual / Histórico)
         **************************************************************/
        // Ya implementado anteriormente

        /**************************************************************
         * NUEVO INFORME: Comisiones Pagadas
         **************************************************************/
        function mostrarComisionesPagadas(){
          const modal = document.getElementById('comisionesPagadasModal');
          const content = document.getElementById('comisionesPagadasContent');
          content.innerHTML = '';

          const pesosInversiones = inversiones.filter(inv => inv.moneda === 'PESOS');
          const dolaresInversiones = inversiones.filter(inv => inv.moneda === 'DOLARES');

          function generarInforme(moneda, inversionesList){
            let totalComisiones = 0;

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            thead.innerHTML = `
              <tr>
                <th>Fecha Adquisición</th>
                <th>Q Cuotaparte</th>
                <th>Precio Compra</th>
                <th>Valor Inversión</th>
                <th>Comisiones Pagadas</th>
                <th>Fecha Venta</th>
                <th>Q Cuotaparte a Vender</th>
                <th>Precio Venta</th>
                <th>Monto</th>
                <th>Comisiones Pagadas (Venta)</th>
              </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            inversionesList.forEach(inv => {
              // Filtrar ventas para esta inversión
              const ventas = operacionesCerradas.filter(op => op.nombre === inv.nombre && op.moneda === moneda);

              ventas.forEach(venta => {
                const valorInversion = inv.cuotaparte * inv.precio;
                const fila = document.createElement('tr');
                fila.innerHTML = `
                  <td>${escapeHTML(inv.fecha)}</td>
                  <td class="number-cell">${formatNumber(inv.cuotaparte, 7)}</td>
                  <td class="number-cell">${formatNumber(inv.precio, 2)}</td>
                  <td class="number-cell">${formatCurrency(valorInversion, moneda, 2)}</td>
                  <td class="number-cell">${formatCurrency(inv.comisionesPagadas, moneda, 2)}</td>
                  <td>${escapeHTML(venta.fecha)}</td>
                  <td class="number-cell">${formatNumber(venta.cuotaparte, 7)}</td>
                  <td class="number-cell">${formatNumber(venta.precioVenta, 2)}</td>
                  <td class="number-cell">${formatCurrency(venta.cuotaparte * venta.precioVenta, moneda, 2)}</td>
                  <td class="number-cell">${formatCurrency(venta.comisiones, moneda, 2)}</td>
                `;
                tbody.appendChild(fila);
                totalComisiones += venta.comisiones;
              });

              // Si no hay ventas, mostrar solo la inversión
              if(ventas.length === 0){
                const valorInversion = inv.cuotaparte * inv.precio;
                const fila = document.createElement('tr');
                fila.innerHTML = `
                  <td>${escapeHTML(inv.fecha)}</td>
                  <td class="number-cell">${formatNumber(inv.cuotaparte, 7)}</td>
                  <td class="number-cell">${formatNumber(inv.precio, 2)}</td>
                  <td class="number-cell">${formatCurrency(valorInversion, moneda, 2)}</td>
                  <td class="number-cell">${formatCurrency(inv.comisionesPagadas, moneda, 2)}</td>
                  <td colspan="5">-</td>
                `;
                tbody.appendChild(fila);
                totalComisiones += inv.comisionesPagadas;
              }
            });

            // Fila de total
            const trTotal = document.createElement('tr');
            trTotal.innerHTML = `
              <td colspan="9" style="text-align:right; font-weight:bold;">Total de Comisiones Pagadas:</td>
              <td class="number-cell" style="font-weight:bold;">${formatCurrency(totalComisiones, moneda, 2)}</td>
            `;
            tbody.appendChild(trTotal);

            table.appendChild(tbody);
            return table;
          }

          // Generar informes separados por moneda
          const tituloPesos = document.createElement('h4');
          tituloPesos.textContent = 'Comisiones Pagadas en Pesos';
          content.appendChild(tituloPesos);
          const tablaPesos = generarInforme('PESOS', pesosInversiones);
          content.appendChild(tablaPesos);

          const tituloDolares = document.createElement('h4');
          tituloDolares.textContent = 'Comisiones Pagadas en Dólares';
          content.appendChild(tituloDolares);
          const tablaDolares = generarInforme('DOLARES', dolaresInversiones);
          content.appendChild(tablaDolares);

          modal.classList.add('visible');
          closeNav(); // Cerrar el menú lateral al abrir el modal
        }
        function cerrarComisionesPagadas(){
          document.getElementById('comisionesPagadasModal').classList.remove('visible');
        }

        /**************************************************************
         * INICIALIZAR
         **************************************************************/
        function inicializarDatos(){
          if(inversiones.length === 0){
            inversiones = [
              {
                fecha: '2023-01-15',
                nombre: 'AAPL - Apple Inc.',
                moneda: 'DOLARES',
                cuotaparte: 10.5,
                precio: 150.75,
                origen: 'EXTRANJERO',
                tipo: 'ACCIONES',
                comisionesPagadas: 0, // Nuevo campo
                valorActual: 160
              },
              {
                fecha: '2023-02-20',
                nombre: 'Bono Gobierno',
                moneda: 'PESOS',
                cuotaparte: 5000,
                precio: 98.5,
                origen: 'LOCAL',
                tipo: 'BONOS',
                comisionesPagadas: 0, // Nuevo campo
                valorActual: 100
              },
              {
                fecha: '2023-03-10',
                nombre: 'Bitcoin',
                moneda: 'DOLARES',
                cuotaparte: 0.5,
                precio: 35000,
                origen: 'EXTRANJERO',
                tipo: 'CRIPTO',
                comisionesPagadas: 0, // Nuevo campo
                valorActual: 40000
              }
            ];
            guardarDatos();
          }
        }
        function inicializarApp(){
          cargarDatos();
          inicializarDatos();
          actualizarSelects();
          actualizarConfigModal();
          actualizarTabla();
        }

        /**************************************************************
         * VALIDACIONES
         **************************************************************/
        // Se ha eliminado toda la lógica de validación en tiempo real

        /**************************************************************
         * INICIALIZAR EVENTOS
         **************************************************************/
        window.onload = inicializarApp;
      </script>
</body>
</html>
